{% extends "base.html" %}

{% block title %}Network Topology - NetGuard Pro{% endblock %}

{% block content %}
<style>
    .topology-container {
        background: #0a0a0a;
        border: 2px solid #2a2a2a;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    
    #network-graph {
        width: 100%;
        height: 700px;
        border-radius: 8px;
        background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
        position: relative;
    }
    
    .node {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .node:hover {
        stroke-width: 4px;
    }
    
    .node-label {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
        font-size: 11px;
        fill: #ddd;
        text-anchor: middle;
        pointer-events: none;
        text-shadow: 0 0 3px #000, 0 0 3px #000;
    }
    
    .link {
        stroke: #00d4ff;
        stroke-opacity: 0.3;
        stroke-width: 1.5px;
    }
    
    .link-active {
        stroke-opacity: 0.8;
        stroke-width: 3px;
    }
    
    .device-details {
        background: #1a1a1a;
        border: 2px solid #00d4ff;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        display: none;
    }
    
    .device-details.show {
        display: block;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .legend {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(26, 26, 26, 0.95);
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        padding: 15px;
        min-width: 200px;
        backdrop-filter: blur(10px);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.85rem;
        color: #ddd;
    }
    
    .legend-item:last-child {
        margin-bottom: 0;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid #fff;
    }
    
    .topology-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .control-btn {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .control-btn:hover {
        background: var(--primary-color);
        color: #000;
        border-color: var(--primary-color);
    }
    
    .control-btn.active {
        background: var(--primary-color);
        color: #000;
        border-color: var(--primary-color);
    }
    
    .stats-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-box {
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    
    .stat-box-label {
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 8px;
    }
    
    .stat-box-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #00d4ff;
    }
</style>

<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="border: 2px solid var(--primary-color);">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff;">
                <h4 class="mb-0">
                    <i class="fas fa-project-diagram"></i> Network Topology Map
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-0" style="color: var(--text-secondary);">
                    Interactive visualization of your network devices and connections. Click on devices for detailed information.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Bar -->
<div class="stats-bar">
    <div class="stat-box">
        <div class="stat-box-label"><i class="fas fa-laptop"></i> Total Devices</div>
        <div class="stat-box-value" id="total-devices">{{ devices|length }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-box-label"><i class="fas fa-microchip"></i> IoT Devices</div>
        <div class="stat-box-value" id="iot-devices">{{ devices|selectattr('device_type', 'equalto', 'IoT')|list|length }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-box-label"><i class="fas fa-network-wired"></i> Active Connections</div>
        <div class="stat-box-value" id="active-connections">{{ connections|length if connections else 0 }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-box-label"><i class="fas fa-shield-alt"></i> Avg Security</div>
        <div class="stat-box-value">{{ (devices|map(attribute='security_score')|sum / devices|length)|round(0)|int if devices else 0 }}</div>
    </div>
</div>

<!-- Topology Controls -->
<div class="topology-controls">
    <button class="control-btn active" onclick="resetZoom()">
        <i class="fas fa-compress-arrows-alt"></i> Reset View
    </button>
    <button class="control-btn" onclick="toggleLabels()">
        <i class="fas fa-tag"></i> Toggle Labels
    </button>
    <button class="control-btn" onclick="filterByType('all')">
        <i class="fas fa-filter"></i> Show All
    </button>
    <button class="control-btn" onclick="filterByType('IoT')">
        <i class="fas fa-microchip"></i> IoT Only
    </button>
    <button class="control-btn" onclick="filterByType('vulnerable')">
        <i class="fas fa-exclamation-triangle"></i> Vulnerable
    </button>
    <button class="control-btn" onclick="exportTopology()">
        <i class="fas fa-download"></i> Export SVG
    </button>
</div>

<!-- Network Graph Container -->
<div class="topology-container">
    <div id="network-graph"></div>
    
    <!-- Legend -->
    <div class="legend">
        <div style="font-weight: 600; color: #00d4ff; margin-bottom: 15px; font-size: 0.95rem;">
            <i class="fas fa-info-circle"></i> Device Types
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff6b6b;"></div>
            <span>IoT Devices</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4ecdc4;"></div>
            <span>Mobile Devices</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #45b7d1;"></div>
            <span>Computers</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffa500;"></div>
            <span>Network Equipment</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #666;"></div>
            <span>Unknown</span>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a2a;">
            <div class="legend-item" style="margin-bottom: 5px;">
                <div style="width: 30px; height: 3px; background: #00d4ff; margin-right: 10px;"></div>
                <span style="font-size: 0.8rem;">Active Connection</span>
            </div>
            <div class="legend-item">
                <div style="width: 20px; height: 20px; border: 3px solid #f44336; border-radius: 50%; margin-right: 10px;"></div>
                <span style="font-size: 0.8rem;">Vulnerable</span>
            </div>
        </div>
    </div>
</div>

<!-- Device Details Panel -->
<div id="device-details" class="device-details">
    <div class="row">
        <div class="col-md-8">
            <h4 style="color: #00d4ff; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> <span id="detail-name">Device Details</span>
            </h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">IP Address</div>
                    <div style="color: #fff; font-weight: 600;" id="detail-ip">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">MAC Address</div>
                    <div style="color: #fff; font-weight: 600; font-family: monospace;" id="detail-mac">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Device Type</div>
                    <div style="color: #fff; font-weight: 600;" id="detail-type">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Vendor</div>
                    <div style="color: #fff; font-weight: 600;" id="detail-vendor">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Last Seen</div>
                    <div style="color: #fff; font-weight: 600;" id="detail-lastseen">-</div>
                </div>
                <div class="col-md-6 mb-3">
                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Security Score</div>
                    <div style="font-size: 1.5rem; font-weight: 700;" id="detail-score">-</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div style="text-align: center; padding: 20px; background: #0a0a0a; border-radius: 8px;">
                <div style="font-size: 4rem; margin-bottom: 10px;" id="detail-icon">
                    <i class="fas fa-microchip"></i>
                </div>
                <div style="color: #888; font-size: 0.9rem;" id="detail-category">Device Category</div>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <a href="/iot-devices" class="btn btn-primary">
            <i class="fas fa-list"></i> View All Devices
        </a>
        <button class="btn btn-secondary" onclick="closeDetails()">
            <i class="fas fa-times"></i> Close
        </button>
    </div>
</div>

<!-- Load D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    // Device data from Flask
    const devicesData = {{ devices|tojson }};
    const connectionsData = {{ connections|tojson if connections else '[]'|safe }};
    
    // Color mapping for device types
    const typeColors = {
        'IoT': '#ff6b6b',
        'Mobile': '#4ecdc4',
        'Computer': '#45b7d1',
        'Network': '#ffa500',
        'Unknown': '#666'
    };
    
    // Graph dimensions
    const width = document.getElementById('network-graph').clientWidth;
    const height = 700;
    
    let labelsVisible = true;
    let currentFilter = 'all';
    
    // Create SVG
    const svg = d3.select('#network-graph')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
    
    // Add zoom behavior
    const g = svg.append('g');
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });
    svg.call(zoom);
    
    // Prepare nodes
    const nodes = devicesData.map(d => ({
        id: d.ip_address,
        name: d.hostname || d.ip_address,
        type: d.device_type || 'Unknown',
        category: d.device_category || 'Unknown',
        score: d.security_score || 50,
        mac: d.mac_address || 'N/A',
        vendor: d.vendor || 'Unknown',
        last_seen: d.last_seen || 'N/A',
        vulnerable: d.security_score < 70
    }));
    
    // Prepare links (connections between devices)
    const links = [];
    
    // Find router/gateway (usually .1)
    const gateway = nodes.find(n => n.id.endsWith('.1')) || nodes[0];
    
    // Create star topology: all devices connect to gateway
    nodes.forEach(node => {
        if (node.id !== gateway.id) {
            links.push({
                source: gateway.id,
                target: node.id,
                strength: Math.random() * 5 + 1
            });
        }
    });
    
    // Create force simulation
    const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(150))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));
    
    // Draw links
    const link = g.append('g')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line')
        .attr('class', 'link')
        .style('stroke-width', d => d.strength);
    
    // Draw nodes
    const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .enter()
        .append('g')
        .attr('class', 'node')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
    
    // Add circles to nodes
    node.append('circle')
        .attr('r', d => d.id === gateway.id ? 30 : 20)
        .attr('fill', d => typeColors[d.type] || '#666')
        .attr('stroke', d => d.vulnerable ? '#f44336' : '#fff')
        .attr('stroke-width', d => d.vulnerable ? 3 : 2)
        .style('filter', d => d.vulnerable ? 'drop-shadow(0 0 10px #f44336)' : 'none');
    
    // Add device icons
    node.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', 5)
        .style('font-size', d => d.id === gateway.id ? '20px' : '14px')
        .style('fill', '#fff')
        .style('pointer-events', 'none')
        .text(d => {
            if (d.type === 'Network') return 'ðŸŒ';
            if (d.type === 'IoT') return 'ðŸ’¡';
            if (d.type === 'Mobile') return 'ðŸ“±';
            if (d.type === 'Computer') return 'ðŸ’»';
            return 'â“';
        });
    
    // Add labels
    const labels = node.append('text')
        .attr('class', 'node-label')
        .attr('dy', 35)
        .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name);
    
    // Add node click handler
    node.on('click', (event, d) => {
        showDeviceDetails(d);
        event.stopPropagation();
    });
    
    // Update positions on simulation tick
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        
        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });
    
    // Drag functions
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
    
    // Show device details
    function showDeviceDetails(device) {
        document.getElementById('detail-name').textContent = device.name;
        document.getElementById('detail-ip').textContent = device.id;
        document.getElementById('detail-mac').textContent = device.mac;
        document.getElementById('detail-type').textContent = device.type;
        document.getElementById('detail-vendor').textContent = device.vendor;
        document.getElementById('detail-category').textContent = device.category;
        document.getElementById('detail-lastseen').textContent = device.last_seen;
        
        const scoreElem = document.getElementById('detail-score');
        scoreElem.textContent = device.score;
        scoreElem.style.color = device.score >= 80 ? '#4caf50' : device.score >= 50 ? '#ff9800' : '#f44336';
        
        // Set icon based on type
        const iconMap = {
            'IoT': 'fa-microchip',
            'Mobile': 'fa-mobile-alt',
            'Computer': 'fa-desktop',
            'Network': 'fa-network-wired',
            'Unknown': 'fa-question-circle'
        };
        document.getElementById('detail-icon').innerHTML = `<i class="fas ${iconMap[device.type] || 'fa-microchip'}"></i>`;
        
        document.getElementById('device-details').classList.add('show');
    }
    
    function closeDetails() {
        document.getElementById('device-details').classList.remove('show');
    }
    
    // Control functions
    function resetZoom() {
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
    }
    
    function toggleLabels() {
        labelsVisible = !labelsVisible;
        labels.style('display', labelsVisible ? 'block' : 'none');
    }
    
    function filterByType(type) {
        currentFilter = type;
        
        node.style('opacity', d => {
            if (type === 'all') return 1;
            if (type === 'vulnerable') return d.vulnerable ? 1 : 0.2;
            return d.type === type ? 1 : 0.2;
        });
        
        link.style('opacity', d => {
            if (type === 'all') return 0.3;
            if (type === 'vulnerable') {
                return (d.source.vulnerable || d.target.vulnerable) ? 0.6 : 0.1;
            }
            return (d.source.type === type || d.target.type === type) ? 0.6 : 0.1;
        });
    }
    
    function exportTopology() {
        const svgData = document.querySelector('#network-graph svg').outerHTML;
        const blob = new Blob([svgData], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'network-topology.svg';
        link.click();
    }
    
    // Auto-refresh every 2 minutes
    setTimeout(() => location.reload(), 120000);
</script>

{% endblock %}

