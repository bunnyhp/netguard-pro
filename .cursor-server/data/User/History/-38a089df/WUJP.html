{% extends "base.html" %}

{% block title %}{{ tool_name }} Data - NetGuard Pro{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">üîç {{ tool_name }} Data</h4>
            </div>
            <div class="card-body">
                <a href="/analysis" class="btn btn-secondary mb-3">‚Üê Back to Analysis Tools</a>
                <p>Viewing all <strong>{{ tool_name }}</strong> capture tables</p>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Statistics Dashboard (tshark only) -->
{% if stats %}
<div class="row mb-4">
    <!-- Total Packets -->
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white">
                <h6 class="text-white-50">Total Packets</h6>
                <h2 class="mb-0">{{ "{:,}".format(stats.total_packets) }}</h2>
            </div>
        </div>
    </div>
    
    <!-- Protocol Count -->
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="card-body text-white">
                <h6 class="text-white-50">Protocols Detected</h6>
                <h2 class="mb-0">{{ stats.protocols|length }}</h2>
            </div>
        </div>
    </div>
    
    <!-- Unique IPs -->
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="card-body text-white">
                <h6 class="text-white-50">Unique Source IPs</h6>
                <h2 class="mb-0">{{ stats.top_sources|length }}</h2>
            </div>
        </div>
    </div>
    
    <!-- Suspicious Activity -->
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <div class="card-body text-white">
                <h6 class="text-white-50">Suspicious Patterns</h6>
                <h2 class="mb-0">{{ stats.suspicious_activity|length }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Protocol Distribution Chart -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä Protocol Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="protocolChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Packet Size Distribution -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üì¶ Packet Size Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="packetSizeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- HTTP, DNS, TLS Analysis -->
<div class="row mb-4">
    <!-- HTTP Hosts -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üåê HTTP Hosts Visited</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.http_hosts %}
                <ul class="list-group list-group-flush">
                    {% for host, count in stats.http_hosts.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <small><code>{{ host }}</code></small>
                        <span class="badge bg-primary rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small">No HTTP traffic detected</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- DNS Queries -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üì° DNS Queries</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.dns_queries %}
                <ul class="list-group list-group-flush">
                    {% for query, count in stats.dns_queries.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <small><code>{{ query }}</code></small>
                        <span class="badge bg-info rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small">No DNS queries detected</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- TLS/SSL Servers -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üîê TLS/SSL Servers</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.tls_servers %}
                <ul class="list-group list-group-flush">
                    {% for server, count in stats.tls_servers.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <small><code>{{ server }}</code></small>
                        <span class="badge bg-success rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted small">No TLS connections detected</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Geographic Distribution and TCP Flags -->
<div class="row mb-4">
    <!-- Countries -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üåç Geographic Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="countryChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- TCP Flags -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üö© TCP Flags Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="tcpFlagsChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top IPs and Ports -->
<div class="row mb-4">
    <!-- Top Source IPs -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üåê Top Source IPs</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for ip, count in stats.top_sources.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <code>{{ ip }}</code>
                        <span class="badge bg-primary rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Top Destination IPs -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üéØ Top Destination IPs</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for ip, count in stats.top_destinations.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <code>{{ ip }}</code>
                        <span class="badge bg-success rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Top Ports -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üîå Top Destination Ports</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush">
                    {% for port, count in stats.port_activity.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <strong>{{ port }}</strong>
                            {% if port == 80 %}<small class="text-muted">(HTTP)</small>
                            {% elif port == 443 %}<small class="text-muted">(HTTPS)</small>
                            {% elif port == 53 %}<small class="text-muted">(DNS)</small>
                            {% elif port == 22 %}<small class="text-muted">(SSH)</small>
                            {% elif port == 21 %}<small class="text-muted">(FTP)</small>
                            {% elif port == 25 %}<small class="text-muted">(SMTP)</small>
                            {% elif port == 3306 %}<small class="text-muted">(MySQL)</small>
                            {% elif port == 3389 %}<small class="text-muted">(RDP)</small>
                            {% endif %}
                        </span>
                        <span class="badge bg-info rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Suspicious Activity Alerts -->
{% if stats.suspicious_activity %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">‚ö†Ô∏è Suspicious Activity Detected</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Details</th>
                                <th>Severity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in stats.suspicious_activity %}
                            <tr>
                                <td><strong>{{ alert.type }}</strong></td>
                                <td>{{ alert.detail }}</td>
                                <td>
                                    {% if alert.severity == 'high' %}
                                    <span class="badge bg-danger">High</span>
                                    {% elif alert.severity == 'medium' %}
                                    <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                    <span class="badge bg-info">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Tables List -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä Capture Tables</h5>
            </div>
            <div class="card-body">
                {% if tables %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablesTable">
                        <thead>
                            <tr>
                                <th>Table Name</th>
                                <th>Timestamp</th>
                                <th>Record Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in tables %}
                            <tr>
                                <td><code>{{ table.name }}</code></td>
                                <td>{{ table.timestamp }}</td>
                                <td><span class="badge bg-primary">{{ table.count }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <h5>No {{ tool_name }} data available yet</h5>
                    <p>Data will appear here once the {{ tool_name }} collector is running and capturing traffic.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Latest Data Preview -->
{% if latest_data %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã Latest Data (Last 100 Records)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm" id="dataTable">
                        <thead>
                            <tr>
                                {% if latest_data[0] %}
                                    {% for key in latest_data[0].keys() %}
                                    <th>{{ key|replace('_', ' ')|title }}</th>
                                    {% endfor %}
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in latest_data %}
                            <tr>
                                {% for key, value in row.items() %}
                                <td>
                                    {% if 'ip' in key|lower and value %}
                                    <span class="ip-address">{{ value }}</span>
                                    {% elif 'port' in key|lower and value %}
                                    <span class="port-number">{{ value }}</span>
                                    {% elif key|lower in ['protocol', 'proto'] and value %}
                                    <span class="protocol-badge">{{ value }}</span>
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
$(document).ready(function() {
    $('#tablesTable').DataTable({
        "order": [[1, "desc"]],
        "pageLength": 25,
        "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]]
    });
    
    {% if latest_data %}
    $('#dataTable').DataTable({
        "order": [[0, "desc"]],
        "pageLength": 50,
        "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
        "scrollX": true
    });
    {% endif %}
    
    {% if stats %}
    // Protocol Distribution Pie Chart
    const protocolCtx = document.getElementById('protocolChart');
    if (protocolCtx) {
        new Chart(protocolCtx, {
            type: 'doughnut',
            data: {
                labels: {{ stats.protocols.keys()|list|tojson }},
                datasets: [{
                    label: 'Packets',
                    data: {{ stats.protocols.values()|list|tojson }},
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(0, 242, 254, 0.8)',
                        'rgba(250, 112, 154, 0.8)',
                        'rgba(254, 225, 64, 0.8)',
                        'rgba(67, 233, 123, 0.8)',
                        'rgba(56, 178, 172, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed || 0;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString() + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Packet Size Distribution Bar Chart
    const packetSizeCtx = document.getElementById('packetSizeChart');
    if (packetSizeCtx) {
        new Chart(packetSizeCtx, {
            type: 'bar',
            data: {
                labels: ['Small (‚â§100)', 'Medium (101-500)', 'Large (>500)'],
                datasets: [{
                    label: 'Packet Count',
                    data: [
                        {{ stats.packet_sizes.small }},
                        {{ stats.packet_sizes.medium }},
                        {{ stats.packet_sizes.large }}
                    ],
                    backgroundColor: [
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)'
                    ],
                    borderColor: [
                        'rgba(79, 172, 254, 1)',
                        'rgba(102, 126, 234, 1)',
                        'rgba(118, 75, 162, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Packets: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}

