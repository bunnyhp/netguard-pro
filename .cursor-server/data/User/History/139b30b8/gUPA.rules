# NetGuard Pro - Custom Suricata Rules for Home Network & IoT Security
# These rules detect IoT-specific threats and home network attacks

# ============================================================================
# IoT Botnet Detection
# ============================================================================

# Mirai Botnet - Telnet brute force attempts
alert tcp any any -> $HOME_NET 23 (msg:"NETGUARD IoT Mirai Telnet Scan Detected"; \
    flow:to_server,established; content:"admin"; nocase; \
    threshold: type both, track by_src, count 3, seconds 60; \
    classtype:attempted-admin; sid:1000001; rev:1;)

alert tcp any any -> $HOME_NET 2323 (msg:"NETGUARD IoT Mirai Alternative Telnet Port"; \
    flow:to_server; flags:S; \
    threshold: type both, track by_src, count 5, seconds 30; \
    classtype:attempted-recon; sid:1000002; rev:1;)

# Mirai default credentials
alert tcp any any -> $HOME_NET 23 (msg:"NETGUARD IoT Mirai Default Credentials Attempt"; \
    flow:to_server,established; content:"root"; nocase; content:"default"; nocase; distance:0; \
    classtype:attempted-admin; sid:1000003; rev:1;)

# Mozi Botnet - DHT protocol abuse
alert udp any any -> $HOME_NET any (msg:"NETGUARD IoT Mozi Botnet DHT Traffic"; \
    content:"|64 31 3a 61 64 32|"; offset:0; depth:6; \
    threshold: type both, track by_src, count 10, seconds 60; \
    classtype:trojan-activity; sid:1000004; rev:1;)

# ============================================================================
# Cryptomining Detection
# ============================================================================

# Monero/Ethereum mining pool connections
alert tcp $HOME_NET any -> any [3333,4444,5555,7777,8888,9999,14444] \
    (msg:"NETGUARD Cryptomining Pool Connection Detected"; \
    flow:to_server,established; \
    threshold: type both, track by_src, count 1, seconds 300; \
    classtype:policy-violation; sid:1000005; rev:1;)

# Coinhive/browser-based mining
alert http $HOME_NET any -> any any (msg:"NETGUARD Browser Cryptomining Script Detected"; \
    flow:to_server; content:"coinhive"; http_uri; nocase; \
    classtype:policy-violation; sid:1000006; rev:1;)

# ============================================================================
# Smart Home Device Exploits
# ============================================================================

# Ring/Arlo Camera exploitation attempts
alert tcp any any -> $HOME_NET any (msg:"NETGUARD Smart Camera Exploit Attempt"; \
    flow:to_server; content:"/snapshot.cgi"; http_uri; nocase; \
    content:"GET"; http_method; \
    classtype:web-application-attack; sid:1000007; rev:1;)

# Smart TV tracking/spying
alert tcp $HOME_NET any -> any 443 (msg:"NETGUARD Smart TV Suspicious Tracking"; \
    flow:to_server,established; \
    content:"samsungads.com"; http_host; nocase; \
    threshold: type both, track by_src, count 10, seconds 300; \
    classtype:policy-violation; sid:1000008; rev:1;)

# Philips Hue Bridge exploit
alert http any any -> $HOME_NET any (msg:"NETGUARD Philips Hue Bridge Unauthorized Access"; \
    flow:to_server; content:"/api"; http_uri; depth:4; \
    content:"PUT"; http_method; pcre:"/\/api\/[^\/]+\/lights/"; \
    classtype:attempted-admin; sid:1000009; rev:1;)

# ============================================================================
# Router/Gateway Exploits
# ============================================================================

# UPnP exploitation (router control)
alert tcp any any -> $HOME_NET 1900 (msg:"NETGUARD UPnP Exploitation Attempt"; \
    flow:to_server; content:"AddPortMapping"; nocase; \
    classtype:attempted-admin; sid:1000010; rev:1;)

# DNS hijacking attempt
alert udp $HOME_NET any -> any 53 (msg:"NETGUARD Suspicious DNS Query Volume"; \
    threshold: type both, track by_src, count 100, seconds 60; \
    classtype:policy-violation; sid:1000011; rev:1;)

# Router admin interface brute force
alert tcp any any -> $HOME_NET [80,443,8080,8443] \
    (msg:"NETGUARD Router Admin Login Brute Force"; \
    flow:to_server; content:"/login"; http_uri; nocase; \
    threshold: type both, track by_src, count 5, seconds 30; \
    classtype:attempted-admin; sid:1000012; rev:1;)

# ============================================================================
# Data Exfiltration
# ============================================================================

# Large outbound transfers from IoT devices
alert tcp $HOME_NET any -> any any (msg:"NETGUARD IoT Device Large Data Upload"; \
    flow:to_server,established; dsize:>50000; \
    threshold: type both, track by_src, count 20, seconds 60; \
    classtype:policy-violation; sid:1000013; rev:1;)

# DNS tunneling (data exfiltration via DNS)
alert dns $HOME_NET any -> any 53 (msg:"NETGUARD DNS Tunneling Suspected"; \
    dns_query; content:"."; pcre:"/^[a-f0-9]{32,}/"; \
    classtype:policy-violation; sid:1000014; rev:1;)

# ============================================================================
# Backdoor/RAT Detection
# ============================================================================

# Common RAT ports
alert tcp $HOME_NET any -> any [1337,31337,4444,5555,6666,9999,12345] \
    (msg:"NETGUARD RAT/Backdoor Connection Attempt"; \
    flow:to_server,established; \
    classtype:trojan-activity; sid:1000015; rev:1;)

# Reverse shell patterns
alert tcp $HOME_NET any -> any any (msg:"NETGUARD Reverse Shell Connection"; \
    flow:to_server; content:"/bin/sh"; nocase; \
    classtype:trojan-activity; sid:1000016; rev:1;)

# ============================================================================
# Home Network Specific
# ============================================================================

# Neighbor WiFi attack (deauth)
alert any any -> any any (msg:"NETGUARD WiFi Deauthentication Attack"; \
    content:"|c0 00|"; offset:0; depth:2; \
    threshold: type both, track by_src, count 10, seconds 10; \
    classtype:denial-of-service; sid:1000017; rev:1;)

# Smart home protocol abuse (MQTT flooding)
alert tcp any any -> $HOME_NET 1883 (msg:"NETGUARD MQTT Flooding Attack"; \
    flow:to_server; \
    threshold: type both, track by_src, count 100, seconds 10; \
    classtype:denial-of-service; sid:1000018; rev:1;)

# Zigbee/Z-Wave exploitation attempts
alert udp any any -> $HOME_NET [15252,4123] (msg:"NETGUARD Smart Home Protocol Exploitation"; \
    threshold: type both, track by_src, count 20, seconds 30; \
    classtype:attempted-admin; sid:1000019; rev:1;)

# ============================================================================
# Suspicious IoT Behavior
# ============================================================================

# IoT device doing port scanning
alert tcp $HOME_NET any -> any any (msg:"NETGUARD IoT Device Port Scanning"; \
    flags:S; \
    threshold: type both, track by_src, count 20, seconds 30; \
    classtype:attempted-recon; sid:1000020; rev:1;)

# IoT device using SSH (unusual for most IoT)
alert tcp $HOME_NET any -> any 22 (msg:"NETGUARD IoT Device SSH Connection"; \
    flow:to_server,established; \
    threshold: type both, track by_src, count 3, seconds 300; \
    classtype:policy-violation; sid:1000021; rev:1;)

# IoT device accessing Tor network
alert tcp $HOME_NET any -> any 9001 (msg:"NETGUARD IoT Device Tor Connection"; \
    flow:to_server,established; \
    classtype:policy-violation; sid:1000022; rev:1;)

# ============================================================================
# Firmware Update Hijacking
# ============================================================================

# Insecure firmware download (HTTP instead of HTTPS)
alert http $HOME_NET any -> any any (msg:"NETGUARD Insecure Firmware Download"; \
    flow:to_server; content:".bin"; http_uri; nocase; \
    content:"GET"; http_method; \
    classtype:policy-violation; sid:1000023; rev:1;)

# Man-in-the-middle firmware update
alert http $HOME_NET any -> any any (msg:"NETGUARD Suspicious Firmware Update Source"; \
    flow:to_server; content:"firmware"; http_uri; nocase; \
    content:"update"; http_uri; nocase; distance:0; \
    pcre:"/http:\/\/([0-9]{1,3}\.){3}[0-9]{1,3}/"; \
    classtype:attempted-admin; sid:1000024; rev:1;)

# ============================================================================
# Privacy & Tracking
# ============================================================================

# Smart TV excessive phone home
alert tcp $HOME_NET any -> any 443 (msg:"NETGUARD Smart TV Excessive Telemetry"; \
    flow:to_server,established; \
    threshold: type both, track by_src, count 50, seconds 300; \
    classtype:policy-violation; sid:1000025; rev:1;)

# Voice assistant always listening
alert tcp $HOME_NET any -> any 443 (msg:"NETGUARD Voice Assistant Continuous Audio Upload"; \
    flow:to_server,established; content:"alexa"; http_host; nocase; \
    dsize:>10000; \
    threshold: type both, track by_src, count 20, seconds 60; \
    classtype:policy-violation; sid:1000026; rev:1;)

# ============================================================================
# Configuration
# ============================================================================

# Note: Update $HOME_NET in suricata.yaml to match your network
# Example: HOME_NET: "[192.168.1.0/24]"

