<!DOCTYPE html>
<html>
<head>
    <title>Chart Fix Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: Arial; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .chart-container { width: 100%; height: 300px; margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 10px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
        .stat { text-align: center; padding: 10px; background: #2a2a2a; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Network Traffic Chart Test</h1>
        
        <div class="stats">
            <div class="stat">
                <div>Total Traffic</div>
                <div id="total-traffic">0 MB</div>
            </div>
            <div class="stat">
                <div>Peak Rate</div>
                <div id="peak-rate">0 Mbps</div>
            </div>
            <div class="stat">
                <div>Suspicious</div>
                <div id="suspicious-traffic">0</div>
            </div>
            <div class="stat">
                <div>Encrypted</div>
                <div id="encrypted-traffic">0%</div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
        
        <button onclick="loadTrafficData()">Load Traffic Data</button>
        <button onclick="initializeTrafficChart()">Recreate Chart</button>
        <button onclick="testChartUpdate()">Test Chart Update</button>
        
        <div id="debug-log" style="background: #000; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        let trafficChart;
        
        function log(message) {
            const debugLog = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }
        
        function initializeTrafficChart() {
            log('Initializing traffic chart...');
            const trafficCtx = document.getElementById('trafficChart');
            if (!trafficCtx) {
                log('ERROR: trafficChart canvas element not found!');
                return;
            }
            
            // Destroy existing chart if it exists
            if (trafficChart) {
                trafficChart.destroy();
                log('Destroyed existing chart');
            }
            
            trafficChart = new Chart(trafficCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Normal Traffic',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#4caf50'
                    }, {
                        label: 'Suspicious Traffic',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#f44336'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' }},
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' }}
                    }
                }
            });
            log('Traffic chart initialized successfully');
        }
        
        function loadTrafficData() {
            log('Loading traffic data...');
            fetch('/api/network-traffic-stats')
                .then(response => {
                    log(`API response: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log(`Data received: ${JSON.stringify(data)}`);
                    
                    // Update stats
                    document.getElementById('total-traffic').textContent = data.total_traffic_mb + ' MB';
                    document.getElementById('peak-rate').textContent = data.peak_rate_mbps + ' Mbps';
                    document.getElementById('suspicious-traffic').textContent = data.suspicious_count;
                    document.getElementById('encrypted-traffic').textContent = data.encrypted_percentage + '%';
                    
                    log('Stats updated');
                    
                    // Update chart
                    if (trafficChart) {
                        log('Updating chart...');
                        const baseTraffic = Math.max(1, data.total_traffic_mb / 7);
                        const baseSuspicious = Math.max(0, data.suspicious_count / 7);
                        
                        const normalData = [
                            Math.round(baseTraffic * (0.8 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (0.9 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (1.0 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (1.1 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (0.7 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (0.6 + Math.random() * 0.4)),
                            Math.round(baseTraffic * (0.8 + Math.random() * 0.4))
                        ];
                        
                        const suspiciousData = [
                            Math.round(baseSuspicious * (0.5 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (0.8 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (0.3 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (1.2 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (0.4 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (0.2 + Math.random() * 1.0)),
                            Math.round(baseSuspicious * (0.6 + Math.random() * 1.0))
                        ];
                        
                        log(`Normal data: ${normalData}`);
                        log(`Suspicious data: ${suspiciousData}`);
                        
                        trafficChart.data.datasets[0].data = normalData;
                        trafficChart.data.datasets[1].data = suspiciousData;
                        
                        try {
                            trafficChart.update('active');
                            log('Chart updated with animation');
                        } catch (e) {
                            log('Animation failed, trying simple update');
                            trafficChart.update();
                        }
                        
                        log('Chart update complete');
                    } else {
                        log('ERROR: trafficChart is not defined!');
                    }
                })
                .catch(error => {
                    log(`ERROR: ${error.message}`);
                });
        }
        
        function testChartUpdate() {
            log('Testing chart update with sample data...');
            if (trafficChart) {
                trafficChart.data.datasets[0].data = [10, 15, 8, 12, 6, 9, 11];
                trafficChart.data.datasets[1].data = [2, 1, 3, 1, 2, 1, 2];
                trafficChart.update();
                log('Test data applied to chart');
            } else {
                log('ERROR: Chart not initialized');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, initializing...');
            initializeTrafficChart();
            setTimeout(() => {
                loadTrafficData();
            }, 1000);
        });
    </script>
</body>
</html>
