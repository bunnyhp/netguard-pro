{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\argus_collector.py","fileUuid":"73ba8d34-e5b5-456f-9fb2-9924522aab92","fileSizeBytes":13795,"numLines":390,"diffChanges":[{"originalStartLineNumberOneIndexed":62,"originalEndLineNumberExclusiveOneIndexed":77,"modifiedStartLineNumberOneIndexed":62,"modifiedEndLineNumberExclusiveOneIndexed":89,"addedLines":["def capture_and_analyze():","    \"\"\"Capture with tshark, then analyze with argus (workaround for argus buffer overflow bug)\"\"\"","    try:","        timestamp_str = datetime.now().strftime('%Y%m%d_%H%M%S')","        pcap_file = os.path.join(CAPTURE_DIR, f\"capture_{timestamp_str}.pcap\")","        argus_output = os.path.join(CAPTURE_DIR, f\"argus_{timestamp_str}.out\")","        ","        # Step 1: Capture packets with tshark (more stable than argus direct capture)","        logging.info(f\"Capturing on {INTERFACE} for 30 seconds...\")","        capture_cmd = [","            'sudo', 'tshark', '-i', INTERFACE,","            '-a', 'duration:30',","            '-w', pcap_file,","            '-q'","        ]","        ","        result = subprocess.run(capture_cmd, capture_output=True, text=True, timeout=40)","        ","        if result.returncode != 0 or not os.path.exists(pcap_file):","            logging.error(f\"Capture failed: {result.stderr}\")","            return False","        ","        logging.info(f\"Captured to {pcap_file}\")","        ","        # Step 2: Analyze PCAP with argus (reading from file works, live capture doesn't)","        logging.info(f\"Analyzing with argus...\")","        argus_cmd = ["],"tokenizedAddedLines":[1000245,1000246,60,174,1000247,1000248,64,1000249,1000250,1000251,1000252,1000253,1000254,1000255,1000256,64,1000257,64,1000258,1000259,81,64,1000260,64,1000261,1000262,1000263]},{"originalStartLineNumberOneIndexed":78,"originalEndLineNumberExclusiveOneIndexed":90,"modifiedStartLineNumberOneIndexed":90,"modifiedEndLineNumberExclusiveOneIndexed":98,"addedLines":["            '-r', pcap_file,","            '-w', argus_output","        ]","        ","        result = subprocess.run(argus_cmd, capture_output=True, text=True, timeout=30)","        ","        if result.returncode != 0:","            logging.error(f\"argus analysis failed: {result.stderr}\")"],"tokenizedAddedLines":[1000264,1000265,1000256,64,1000266,64,1000267,1000268]},{"originalStartLineNumberOneIndexed":91,"originalEndLineNumberExclusiveOneIndexed":91,"modifiedStartLineNumberOneIndexed":99,"modifiedEndLineNumberExclusiveOneIndexed":109,"addedLines":["        ","        logging.info(f\"âœ“ argus analysis complete: {argus_output}\")","        ","        # Clean up PCAP file","        try:","            os.remove(pcap_file)","        except:","            pass","        ","        return True"],"tokenizedAddedLines":[64,1000269,64,1000270,95,1000271,97,219,64,1000272]},{"originalStartLineNumberOneIndexed":93,"originalEndLineNumberExclusiveOneIndexed":94,"modifiedStartLineNumberOneIndexed":111,"modifiedEndLineNumberExclusiveOneIndexed":112,"addedLines":["        logging.error(f\"Error in capture_and_analyze: {e}\")"],"tokenizedAddedLines":[1000273]},{"originalStartLineNumberOneIndexed":200,"originalEndLineNumberExclusiveOneIndexed":201,"modifiedStartLineNumberOneIndexed":218,"modifiedEndLineNumberExclusiveOneIndexed":219,"addedLines":["def collect_argus_data(argus_output_file=None):"],"tokenizedAddedLines":[1000274]},{"originalStartLineNumberOneIndexed":203,"originalEndLineNumberExclusiveOneIndexed":204,"modifiedStartLineNumberOneIndexed":221,"modifiedEndLineNumberExclusiveOneIndexed":225,"addedLines":["        # Use provided file or default ARGUS_FILE","        file_to_process = argus_output_file if argus_output_file else ARGUS_FILE","        ","        if not os.path.exists(file_to_process):"],"tokenizedAddedLines":[1000275,1000276,64,1000277]},{"originalStartLineNumberOneIndexed":209,"originalEndLineNumberExclusiveOneIndexed":210,"modifiedStartLineNumberOneIndexed":230,"modifiedEndLineNumberExclusiveOneIndexed":233,"addedLines":["        # -c: comma-separated output for easier parsing","        cmd = ['ra', '-r', file_to_process, '-n', '-c', ',', '-s', ","               'stime,ltime,dur,saddr,sport,daddr,dport,proto,spkts,dpkts,sbytes,dbytes,state']"],"tokenizedAddedLines":[1000278,1000279,1000280]},{"originalStartLineNumberOneIndexed":214,"originalEndLineNumberExclusiveOneIndexed":214,"modifiedStartLineNumberOneIndexed":237,"modifiedEndLineNumberExclusiveOneIndexed":238,"addedLines":["            logging.warning(f\"No output from ra command\")"],"tokenizedAddedLines":[1000281]},{"originalStartLineNumberOneIndexed":217,"originalEndLineNumberExclusiveOneIndexed":217,"modifiedStartLineNumberOneIndexed":241,"modifiedEndLineNumberExclusiveOneIndexed":242,"addedLines":["        logging.info(f\"ra returned {len(lines)} lines\")"],"tokenizedAddedLines":[1000282]},{"originalStartLineNumberOneIndexed":222,"originalEndLineNumberExclusiveOneIndexed":222,"modifiedStartLineNumberOneIndexed":247,"modifiedEndLineNumberExclusiveOneIndexed":248,"addedLines":["            logging.warning(\"No data lines after filtering headers\")"],"tokenizedAddedLines":[1000283]},{"originalStartLineNumberOneIndexed":224,"originalEndLineNumberExclusiveOneIndexed":225,"modifiedStartLineNumberOneIndexed":250,"modifiedEndLineNumberExclusiveOneIndexed":253,"addedLines":["        logging.info(f\"Processing {len(data_lines)} flow records\")","        ","        # Parse flows (CSV format: stime,ltime,dur,saddr,sport,daddr,dport,proto,spkts,dpkts,sbytes,dbytes,state)"],"tokenizedAddedLines":[1000284,64,1000285]},{"originalStartLineNumberOneIndexed":227,"originalEndLineNumberExclusiveOneIndexed":231,"modifiedStartLineNumberOneIndexed":255,"modifiedEndLineNumberExclusiveOneIndexed":278,"addedLines":["            try:","                parts = line.split(',')","                if len(parts) >= 13:","                    flow = {","                        'timestamp': datetime.now().isoformat(),","                        'start_time': parts[0].strip(),","                        'last_time': parts[1].strip(),","                        'duration': float(parts[2].strip()) if parts[2].strip() else 0,","                        'src_ip': parts[3].strip(),","                        'src_port': int(parts[4].strip()) if parts[4].strip() and parts[4].strip().isdigit() else None,","                        'dest_ip': parts[5].strip(),","                        'dest_port': int(parts[6].strip()) if parts[6].strip() and parts[6].strip().isdigit() else None,","                        'proto': parts[7].strip(),","                        'src_packets': int(parts[8].strip()) if parts[8].strip() else 0,","                        'dest_packets': int(parts[9].strip()) if parts[9].strip() else 0,","                        'src_bytes': int(parts[10].strip()) if parts[10].strip() else 0,","                        'dest_bytes': int(parts[11].strip()) if parts[11].strip() else 0,","                        'state': parts[12].strip()","                    }","                    flows.append(flow)","            except Exception as e:","                logging.debug(f\"Error parsing line: {e}\")","                continue"],"tokenizedAddedLines":[182,1000286,1000287,1000288,1000289,1000290,1000291,1000292,1000293,1000294,1000295,1000296,1000297,1000298,1000299,1000300,1000301,1000302,1000303,1000304,205,1000305,207]},{"originalStartLineNumberOneIndexed":233,"originalEndLineNumberExclusiveOneIndexed":233,"modifiedStartLineNumberOneIndexed":280,"modifiedEndLineNumberExclusiveOneIndexed":281,"addedLines":["            logging.warning(\"No flows parsed successfully\")"],"tokenizedAddedLines":[1000306]},{"originalStartLineNumberOneIndexed":235,"originalEndLineNumberExclusiveOneIndexed":235,"modifiedStartLineNumberOneIndexed":283,"modifiedEndLineNumberExclusiveOneIndexed":285,"addedLines":["        logging.info(f\"Successfully parsed {len(flows)} flows\")","        "],"tokenizedAddedLines":[1000307,64]},{"originalStartLineNumberOneIndexed":308,"originalEndLineNumberExclusiveOneIndexed":312,"modifiedStartLineNumberOneIndexed":358,"modifiedEndLineNumberExclusiveOneIndexed":360,"addedLines":["    # Use workaround: tshark capture + argus analysis","    logging.info(\"Using PCAP workaround for argus buffer overflow bug\")"],"tokenizedAddedLines":[1000308,1000309]},{"originalStartLineNumberOneIndexed":315,"originalEndLineNumberExclusiveOneIndexed":315,"modifiedStartLineNumberOneIndexed":363,"modifiedEndLineNumberExclusiveOneIndexed":380,"addedLines":["            # Capture and analyze","            if capture_and_analyze():","                # Find the latest argus output file","                argus_files = sorted([f for f in os.listdir(CAPTURE_DIR) if f.startswith('argus_') and f.endswith('.out')])","                if argus_files:","                    latest_file = os.path.join(CAPTURE_DIR, argus_files[-1])","                    logging.info(f\"Processing {latest_file}...\")","                    collect_argus_data(latest_file)","                    # Clean up","                    try:","                        os.remove(latest_file)","                        logging.info(f\"Cleaned up {latest_file}\")","                    except Exception as e:","                        logging.debug(f\"Error cleaning up: {e}\")","                else:","                    logging.warning(\"No argus output files found\")","            "],"tokenizedAddedLines":[1000310,1000311,1000312,1000313,1000314,1000315,1000316,1000317,1000318,1000319,1000320,1000321,1000322,1000323,1000324,1000325,82]},{"originalStartLineNumberOneIndexed":316,"originalEndLineNumberExclusiveOneIndexed":317,"modifiedStartLineNumberOneIndexed":381,"modifiedEndLineNumberExclusiveOneIndexed":382,"addedLines":["            "],"tokenizedAddedLines":[82]},{"originalStartLineNumberOneIndexed":319,"originalEndLineNumberExclusiveOneIndexed":322,"modifiedStartLineNumberOneIndexed":384,"modifiedEndLineNumberExclusiveOneIndexed":384},{"originalStartLineNumberOneIndexed":324,"originalEndLineNumberExclusiveOneIndexed":326,"modifiedStartLineNumberOneIndexed":386,"modifiedEndLineNumberExclusiveOneIndexed":386}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}