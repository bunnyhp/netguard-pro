{"fsPath":"\\home\\jarvis\\NetGuard\\web\\app.py","fileUuid":"ce3724c8-f607-4f15-a412-aa5caa93ae68","fileSizeBytes":93455,"numLines":2385,"diffChanges":[{"originalStartLineNumberOneIndexed":1672,"originalEndLineNumberExclusiveOneIndexed":1673,"modifiedStartLineNumberOneIndexed":1672,"modifiedEndLineNumberExclusiveOneIndexed":1674,"addedLines":["    \"\"\"API endpoint for AI dashboard statistics - Real Data from AI Analysis\"\"\"","    try:"],"tokenizedAddedLines":[1001373,34]},{"originalStartLineNumberOneIndexed":1676,"originalEndLineNumberExclusiveOneIndexed":1692,"modifiedStartLineNumberOneIndexed":1677,"modifiedEndLineNumberExclusiveOneIndexed":1701,"addedLines":["        # Get latest AI analysis","        cursor.execute(\"\"\"","            SELECT threat_level, network_health_score, summary, timestamp, threats_detected","            FROM ai_analysis ","            ORDER BY timestamp DESC LIMIT 1","        \"\"\")","        latest_analysis = cursor.fetchone()","        ","        # Get device count","        cursor.execute(\"SELECT COUNT(*) FROM devices\")","        device_count = cursor.fetchone()[0]","        ","        # Count active threats from latest analysis","        active_threats = 0","        if latest_analysis and latest_analysis['threats_detected']:","            try:","                threats = json.loads(latest_analysis['threats_detected'])","                active_threats = len([t for t in threats if t.get('severity') in ['HIGH', 'CRITICAL']])","            except:","                active_threats = 0","        ","        # Get total AI analyses count","        cursor.execute(\"SELECT COUNT(*) FROM ai_analysis\")","        total_analyses = cursor.fetchone()[0]"],"tokenizedAddedLines":[1001374,680,1001375,1001376,1001377,685,1001378,47,1001379,1001380,1001381,47,1001382,1001383,1001384,74,1001385,1001386,410,1001387,47,1001388,1001389,1001390]},{"originalStartLineNumberOneIndexed":1695,"originalEndLineNumberExclusiveOneIndexed":1695,"modifiedStartLineNumberOneIndexed":1704,"modifiedEndLineNumberExclusiveOneIndexed":1705,"addedLines":["        if latest_analysis:"],"tokenizedAddedLines":[1001391]},{"originalStartLineNumberOneIndexed":1696,"originalEndLineNumberExclusiveOneIndexed":1697,"modifiedStartLineNumberOneIndexed":1706,"modifiedEndLineNumberExclusiveOneIndexed":1710,"addedLines":["                'threat_level': latest_analysis['threat_level'] or 'LOW',","                'network_health_score': latest_analysis['network_health_score'] or 85,","                'active_threats': active_threats,","                'devices_monitored': device_count,"],"tokenizedAddedLines":[1001392,1001393,1001394,1001395]},{"originalStartLineNumberOneIndexed":1698,"originalEndLineNumberExclusiveOneIndexed":1703,"modifiedStartLineNumberOneIndexed":1711,"modifiedEndLineNumberExclusiveOneIndexed":1918,"addedLines":["                'last_analysis': latest_analysis['timestamp'],","                'summary': latest_analysis['summary'] or 'Network monitoring active'","            })","        else:","            return jsonify({","                'threat_level': 'LOW',","                'network_health_score': 85,","                'active_threats': 0,","                'devices_monitored': device_count,","                'total_analyses': 0,","                'last_analysis': datetime.now().isoformat(),","                'summary': 'No recent AI analysis available'","            })","            ","    except Exception as e:","        logging.error(f\"Error in AI dashboard API stats: {e}\")","        return jsonify({","            'threat_level': 'LOW',","            'network_health_score': 85,","            'active_threats': 0,","            'devices_monitored': 0,","            'total_analyses': 0,","            'last_analysis': datetime.now().isoformat(),","            'summary': 'Error loading data'","        })","","@app.route('/ai-dashboard/api/network-devices')","def ai_network_devices_api():","    \"\"\"API endpoint for Network Devices & Activity - Uses Real Device Data\"\"\"","    try:","        conn = get_db_connection()","        cursor = conn.cursor()","        ","        # Get real device data","        cursor.execute(\"\"\"","            SELECT ip_address, hostname, device_type, device_category, vendor, ","                   mac_address, last_seen, security_score","            FROM devices ","            ORDER BY last_seen DESC ","            LIMIT 20","        \"\"\")","        devices = [dict(row) for row in cursor.fetchall()]","        ","        # Get device type distribution","        cursor.execute(\"\"\"","            SELECT device_type, COUNT(*) as count","            FROM devices ","            GROUP BY device_type","        \"\"\")","        device_types = {row['device_type']: row['count'] for row in cursor.fetchall()}","        ","        # Get recent activity (last hour)","        cursor.execute(\"\"\"","            SELECT COUNT(*) as recent_activity","            FROM (","                SELECT name FROM sqlite_master ","                WHERE type='table' AND name LIKE 'tcpdump_%'","                ORDER BY name DESC LIMIT 1","            ) AS latest_table,","            (SELECT * FROM tcpdump ","             WHERE timestamp > datetime('now', '-1 hour')","             LIMIT 1000)","        \"\"\")","        recent_activity = cursor.fetchone()['recent_activity'] if cursor.fetchone() else 0","        ","        conn.close()","        ","        return jsonify({","            'devices': devices,","            'device_types': device_types,","            'total_devices': len(devices),","            'recent_activity': recent_activity,","            'last_updated': datetime.now().isoformat()","        })","        ","    except Exception as e:","        logging.error(f\"Error in network devices API: {e}\")","        return jsonify({","            'devices': [],","            'device_types': {},","            'total_devices': 0,","            'recent_activity': 0,","            'last_updated': datetime.now().isoformat()","        })","","@app.route('/ai-dashboard/api/threat-timeline')","def ai_threat_timeline_api():","    \"\"\"API endpoint for threat timeline - Real Data\"\"\"","    try:","        conn = get_db_connection()","        cursor = conn.cursor()","        ","        # Get threat timeline from AI analysis","        cursor.execute(\"\"\"","            SELECT timestamp, threat_level, summary, threats_detected","            FROM ai_analysis ","            WHERE timestamp > datetime('now', '-24 hours')","            ORDER BY timestamp DESC","            LIMIT 20","        \"\"\")","        ","        timeline = []","        for row in cursor.fetchall():","            timeline.append({","                'timestamp': row['timestamp'],","                'threat_level': row['threat_level'],","                'summary': row['summary'],","                'threats_count': len(json.loads(row['threats_detected'])) if row['threats_detected'] else 0","            })","        ","        conn.close()","        return jsonify(timeline)","        ","    except Exception as e:","        logging.error(f\"Error in threat timeline API: {e}\")","        return jsonify([])","","@app.route('/ai-dashboard/api/device-activity')","def ai_device_activity_api():","    \"\"\"API endpoint for device activity - Real Data\"\"\"","    try:","        conn = get_db_connection()","        cursor = conn.cursor()","        ","        # Get device activity from recent traffic","        cursor.execute(\"\"\"","            SELECT ","                src_ip as device_ip,","                COUNT(*) as packet_count,","                COUNT(DISTINCT dest_ip) as unique_connections,","                MAX(timestamp) as last_activity","            FROM (","                SELECT name FROM sqlite_master ","                WHERE type='table' AND name LIKE 'tcpdump_%'","                ORDER BY name DESC LIMIT 1","            ) AS latest_table,","            (SELECT * FROM tcpdump ","             WHERE timestamp > datetime('now', '-1 hour')","             AND src_ip LIKE '192.168.%'","             LIMIT 1000)","            GROUP BY src_ip","            ORDER BY packet_count DESC","            LIMIT 10","        \"\"\")","        ","        activity = [dict(row) for row in cursor.fetchall()]","        conn.close()","        return jsonify(activity)","        ","    except Exception as e:","        logging.error(f\"Error in device activity API: {e}\")","        return jsonify([])","","@app.route('/ai-dashboard/api/protocol-distribution')","def ai_protocol_distribution_api():","    \"\"\"API endpoint for protocol distribution - Real Data\"\"\"","    try:","        conn = get_db_connection()","        cursor = conn.cursor()","        ","        # Get protocol distribution from tshark data","        cursor.execute(\"\"\"","            SELECT protocol, COUNT(*) as count","            FROM (","                SELECT name FROM sqlite_master ","                WHERE type='table' AND name LIKE 'tshark_%'","                ORDER BY name DESC LIMIT 1","            ) AS latest_table,","            (SELECT * FROM tshark ","             WHERE timestamp > datetime('now', '-1 hour')","             LIMIT 1000)","            GROUP BY protocol","            ORDER BY count DESC","        \"\"\")","        ","        protocols = {row['protocol']: row['count'] for row in cursor.fetchall()}","        conn.close()","        return jsonify(protocols)","        ","    except Exception as e:","        logging.error(f\"Error in protocol distribution API: {e}\")","        return jsonify({})","","@app.route('/ai-dashboard/api/health-history')","def ai_health_history_api():","    \"\"\"API endpoint for network health history - Real Data\"\"\"","    try:","        conn = get_db_connection()","        cursor = conn.cursor()","        ","        # Get health history from AI analysis","        cursor.execute(\"\"\"","            SELECT timestamp, network_health_score, threat_level","            FROM ai_analysis ","            WHERE timestamp > datetime('now', '-24 hours')","            ORDER BY timestamp ASC","            LIMIT 50","        \"\"\")","        ","        history = [dict(row) for row in cursor.fetchall()]","        conn.close()","        return jsonify(history)","        ","    except Exception as e:","        logging.error(f\"Error in health history API: {e}\")","        return jsonify([])",""],"tokenizedAddedLines":[1001396,1001397,445,761,1001398,1001399,1001400,1001401,1001395,1001402,1001403,1001404,445,187,53,1001405,785,1001406,1001407,1001408,1001409,1001410,1001411,1001412,362,5,1001413,1001414,1001415,34,35,36,47,1001416,680,1001417,1001418,1001419,1001420,1001421,685,1001422,47,1001423,680,1001424,1001419,1001425,685,1001426,47,1001427,680,1001428,1001429,618,1001430,621,1001431,1001432,1001433,1001434,685,1001435,47,39,47,785,1001436,325,1001437,1001438,1001439,362,47,53,1001440,785,1001441,349,348,1001442,1001439,362,5,1001443,1001444,1001445,34,35,36,47,1001446,680,1001447,1001376,1001448,1001449,1001421,685,47,1001450,687,1001451,1001452,1001453,1001454,1001455,445,47,39,1001456,47,53,1001457,773,5,1001458,1001459,1001460,34,35,36,47,1001461,680,1001462,1001463,1001464,1001465,1001466,1001429,618,1001430,621,1001431,1001432,1001433,1001467,1001434,1001468,1001469,1001470,685,47,1001471,39,1001472,47,53,1001473,773,5,1001474,1001475,1001476,34,35,36,47,1001477,680,1001478,1001429,618,1001479,621,1001431,1001480,1001433,1001434,1001481,1001482,685,47,1001483,39,1001484,47,53,1001485,1001486,5,1001487,1001488,1001489,34,35,36,47,1001490,680,1001491,1001376,1001448,1001492,684,685,47,1001493,39,1001494,47,53,1001495,773,5]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}