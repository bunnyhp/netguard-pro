{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\ai_connector_v2.py","fileUuid":"b274aab7-b8cd-4efe-948a-ffc358bf4a2c","fileSizeBytes":18393,"numLines":513,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":514,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - AI Connector v2","Uses JSON config file and comprehensive data from all tools","\"\"\"","","import json","import sqlite3","import logging","import re","from datetime import datetime","from comprehensive_data_aggregator import aggregate_all_data, export_for_ai, load_config","","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","CONFIG_PATH = \"/home/jarvis/NetGuard/config/ai_config.json\"","","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s'",")","","","class MultiAIAnalyzer:","    \"\"\"Multi-provider AI analyzer with automatic fallback\"\"\"","    ","    def __init__(self, config):","        self.config = config","        self.api_keys = config.get('api_keys', {})","        self.models = self._load_model_configs()","        ","    def _load_model_configs(self):","        \"\"\"Load AI model configurations\"\"\"","        return [","            {","                'name': 'Gemini 2.0 Flash',","                'provider': 'gemini',","                'model': 'gemini-2.0-flash-exp',","                'api_key': self.api_keys.get('gemini_api_key'),","                'priority': 1","            },","            {","                'name': 'Groq Llama 3.3 70B',","                'provider': 'groq',","                'model': 'llama-3.3-70b-versatile',","                'api_key': self.api_keys.get('groq_api_key'),","                'priority': 2","            },","            {","                'name': 'OpenRouter DeepSeek R1',","                'provider': 'openrouter',","                'model': 'deepseek/deepseek-r1',","                'api_key': self.api_keys.get('openrouter_api_key'),","                'priority': 3","            }","        ]","    ","    def analyze_network_data(self, data):","        \"\"\"Analyze comprehensive network data with AI\"\"\"","        ","        logging.info(f\"Starting AI analysis with {len(self.models)} available models\")","        ","        for model_config in self.models:","            api_key = model_config.get('api_key')","            ","            if not api_key or api_key == 'YOUR_GEMINI_KEY_HERE' or api_key == 'YOUR_GROQ_KEY_HERE' or api_key == 'YOUR_OPENROUTER_KEY_HERE':","                logging.debug(f\"‚è≠Ô∏è  Skipping {model_config['name']} (no API key)\")","                continue","            ","            try:","                logging.info(f\"ü§ñ Trying {model_config['name']}...\")","                ","                if model_config['provider'] == 'gemini':","                    result = self._call_gemini(data, model_config, api_key)","                elif model_config['provider'] == 'groq':","                    result = self._call_groq(data, model_config, api_key)","                elif model_config['provider'] == 'openrouter':","                    result = self._call_openrouter(data, model_config, api_key)","                else:","                    continue","                ","                if result:","                    logging.info(f\"‚úÖ Success with {model_config['name']}!\")","                    result['ai_model_used'] = model_config['name']","                    return result","                    ","            except Exception as e:","                logging.warning(f\"‚ùå {model_config['name']} failed: {str(e)[:100]}\")","                continue","        ","        logging.error(\"‚ùå All AI models failed or no API keys configured\")","        return None","    ","    def _call_gemini(self, data, config, api_key):","        \"\"\"Call Google Gemini API\"\"\"","        try:","            import google.generativeai as genai","        except ImportError:","            logging.error(\"google-generativeai not installed\")","            return None","        ","        try:","            genai.configure(api_key=api_key)","            model = genai.GenerativeModel(config['model'])","            ","            prompt = self._build_comprehensive_prompt(data)","            ","            response = model.generate_content(","                prompt,","                generation_config={","                    'temperature': 0.3,","                    'max_output_tokens': 4096,","                }","            )","            ","            return self._parse_json_response(response.text)","            ","        except Exception as e:","            logging.error(f\"Gemini error: {e}\")","            return None","    ","    def _call_groq(self, data, config, api_key):","        \"\"\"Call Groq API\"\"\"","        try:","            from groq import Groq","        except ImportError:","            logging.error(\"groq not installed\")","            return None","        ","        try:","            client = Groq(api_key=api_key)","            ","            response = client.chat.completions.create(","                model=config['model'],","                messages=[","                    {\"role\": \"system\", \"content\": \"You are an expert network security analyst. Analyze network traffic and identify threats. Always respond with valid JSON only.\"},","                    {\"role\": \"user\", \"content\": self._build_comprehensive_prompt(data)}","                ],","                temperature=0.3,","                max_tokens=4096,","                response_format={\"type\": \"json_object\"}","            )","            ","            return self._parse_json_response(response.choices[0].message.content)","            ","        except Exception as e:","            logging.error(f\"Groq error: {e}\")","            return None","    ","    def _call_openrouter(self, data, config, api_key):","        \"\"\"Call OpenRouter API\"\"\"","        try:","            from openai import OpenAI","        except ImportError:","            logging.error(\"openai not installed\")","            return None","        ","        try:","            client = OpenAI(","                base_url=\"https://openrouter.ai/api/v1\",","                api_key=api_key","            )","            ","            response = client.chat.completions.create(","                model=config['model'],","                messages=[","                    {\"role\": \"system\", \"content\": \"You are an expert network security analyst. Analyze network traffic and identify threats. Always respond with valid JSON only.\"},","                    {\"role\": \"user\", \"content\": self._build_comprehensive_prompt(data)}","                ],","                temperature=0.3,","                max_tokens=4096","            )","            ","            return self._parse_json_response(response.choices[0].message.content)","            ","        except Exception as e:","            logging.error(f\"OpenRouter error: {e}\")","            return None","    ","    def _build_comprehensive_prompt(self, data):","        \"\"\"Build comprehensive analysis prompt with all tool data\"\"\"","        ","        stats = data.get('overall_statistics', {})","        suricata = data.get('suricata_alerts', [])","        tcpdump_summary = data.get('tcpdump', {}).get('summary', {})","        http = data.get('http_traffic', [])","        flows = data.get('network_flows', [])","        ","        prompt = f\"\"\"You are a senior network security analyst with 30 years of experience. Analyze this comprehensive network security data from multiple monitoring tools.","","**CRITICAL DATA SOURCES:**","","1. **Suricata IDS Alerts** ({len(suricata)} alerts)","   - Real-time intrusion detection alerts","   - Signature-based threat detection","   - {json.dumps(suricata[:10], indent=2) if suricata else 'No alerts'}","","2. **tcpdump Packet Analysis** ({tcpdump_summary.get('total_packets', 0)} packets)","   - Total bytes: {tcpdump_summary.get('total_bytes', 0)}","   - Unique sources: {tcpdump_summary.get('unique_src_ips', 0)}","   - Unique destinations: {tcpdump_summary.get('unique_dst_ips', 0)}","   - Protocols: {json.dumps(tcpdump_summary.get('protocols', {}))}","","3. **HTTP Traffic** ({len(http)} requests)","   {json.dumps(http[:10], indent=2) if http else 'No HTTP traffic'}","","4. **Network Flows** ({len(flows)} flows)","   {json.dumps(flows[:10], indent=2) if flows else 'No flows'}","","**ANALYSIS REQUIREMENTS:**","","1. **Threat Detection:**","   - Analyze Suricata alerts for critical threats","   - Correlate with packet data and flows","   - Identify: Port scans, DDoS, Malware, Botnets, Data exfiltration","   - Rate severity: CRITICAL, HIGH, MEDIUM, LOW","","2. **Anomaly Detection:**","   - Traffic volume spikes","   - Unusual protocols or ports","   - Suspicious connection patterns","   - Off-hours activity","","3. **URL/Domain Analysis:**","   - Extract domains from HTTP traffic","   - Identify: Phishing, DGA, C&C servers, Malware domains","   - Check for typosquatting","","4. **Network Health:**","   - Overall network health score (0-100)","   - Based on: Alert severity, traffic patterns, anomalies","","**RESPOND WITH ONLY VALID JSON (no markdown):**","","{{","  \"analysis_timestamp\": \"{datetime.now().isoformat()}\",","  \"overall_threat_level\": \"LOW|MEDIUM|HIGH|CRITICAL\",","  \"network_health_score\": 0-100,","  \"suricata_analysis\": {{","    \"total_alerts\": {len(suricata)},","    \"critical_alerts\": 0,","    \"high_priority_threats\": [],","    \"alert_categories\": {{}}","  }},","  \"threats_detected\": [","    {{","      \"threat_id\": \"THR-{datetime.now().strftime('%Y%m%d')}-001\",","      \"severity\": \"CRITICAL|HIGH|MEDIUM|LOW\",","      \"confidence\": 0.0-1.0,","      \"threat_type\": \"Port Scan|DDoS|Malware|Botnet|Data Exfiltration|IDS Alert\",","      \"source_ip\": \"x.x.x.x\",","      \"target_ip\": \"x.x.x.x\",","      \"description\": \"Detailed threat description\",","      \"suricata_correlation\": \"Related Suricata alert if any\",","      \"recommendation\": \"Specific action to take\",","      \"indicators\": [\"list of indicators\"]","    }}","  ],","  \"device_anomalies\": [","    {{","      \"device_ip\": \"x.x.x.x\",","      \"anomaly_score\": 0.0-1.0,","      \"anomaly_type\": \"Unusual Traffic Volume|Suspicious Protocol|etc\",","      \"description\": \"What is unusual\"","    }}","  ],","  \"url_classifications\": [","    {{","      \"url\": \"http://example.com\",","      \"domain\": \"example.com\",","      \"risk_score\": 0.0-1.0,","      \"category\": \"Phishing|Malware|DGA|C&C|Safe\",","      \"action\": \"BLOCK|WARN|ALLOW\",","      \"accessed_by\": [\"list of IPs\"]","    }}","  ],","  \"behavior_patterns\": [","    {{","      \"pattern_type\": \"Botnet Beacon|Scanning Activity|Data Exfiltration\",","      \"confidence\": 0.0-1.0,","      \"device_ip\": \"x.x.x.x\",","      \"description\": \"Pattern description\"","    }}","  ],","  \"alerts\": [","    {{","      \"alert_id\": \"ALT-{datetime.now().strftime('%Y%m%d')}-001\",","      \"priority\": \"CRITICAL|HIGH|MEDIUM|LOW\",","      \"title\": \"Short title\",","      \"message\": \"Detailed message for homeowner\",","      \"threat_type\": \"IDS Alert|Port Scan|Malware|etc\",","      \"source_ip\": \"x.x.x.x\",","      \"confidence\": 0.0-1.0,","      \"recommended_action\": \"Action to take\",","      \"suricata_related\": true|false","    }}","  ],","  \"statistics\": {{","    \"packets_analyzed\": {stats.get('total_data_points', 0)},","    \"threats_found\": 0,","    \"suricata_alerts_processed\": {len(suricata)},","    \"http_requests_analyzed\": {len(http)},","    \"flows_analyzed\": {len(flows)}","  }}","}}","","IMPORTANT: Return ONLY the JSON object. No markdown, no explanations.","\"\"\"","        ","        return prompt","    ","    def _parse_json_response(self, text):","        \"\"\"Parse JSON from AI response\"\"\"","        text = text.strip()","        ","        # Remove markdown code blocks","        if text.startswith('```'):","            text = re.sub(r'^```(?:json)?\\s*\\n', '', text)","            text = re.sub(r'\\n```\\s*$', '', text)","        ","        try:","            return json.loads(text)","        except json.JSONDecodeError as e:","            logging.error(f\"Failed to parse JSON: {e}\")","            logging.debug(f\"Response: {text[:500]}...\")","            return None","","","def store_ai_predictions(ai_response):","    \"\"\"Store AI analysis results in database\"\"\"","    if not ai_response:","        return False","    ","    conn = sqlite3.connect(DB_PATH)","    cursor = conn.cursor()","    ","    try:","        # Store main prediction","        cursor.execute(\"\"\"","            INSERT INTO ai_predictions (","                timestamp, analysis_window, threat_level, network_health_score,","                threats_detected, anomalies_detected, alerts_generated,","                threats_json, anomalies_json, patterns_json, processing_time_ms","            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)","        \"\"\", (","            ai_response.get('analysis_timestamp'),","            '5m',","            ai_response.get('overall_threat_level'),","            ai_response.get('network_health_score'),","            len(ai_response.get('threats_detected', [])),","            len(ai_response.get('device_anomalies', [])),","            len(ai_response.get('alerts', [])),","            json.dumps(ai_response.get('threats_detected', [])),","            json.dumps(ai_response.get('device_anomalies', [])),","            json.dumps(ai_response.get('behavior_patterns', [])),","            ai_response.get('statistics', {}).get('processing_time_ms', 0)","        ))","        ","        # Store alerts","        for alert in ai_response.get('alerts', []):","            cursor.execute(\"\"\"","                INSERT INTO ai_alerts (","                    alert_id, priority, title, message, threat_type,","                    source_ip, confidence, indicators, recommended_action,","                    timestamp","                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)","            \"\"\", (","                alert.get('alert_id'),","                alert.get('priority'),","                alert.get('title'),","                alert.get('message'),","                alert.get('threat_type', 'Unknown'),","                alert.get('source_ip'),","                alert.get('confidence', 0.0),","                json.dumps(alert.get('indicators', [])),","                alert.get('recommended_action'),","                datetime.now().isoformat()","            ))","        ","        # Store URL classifications","        for url_data in ai_response.get('url_classifications', []):","            cursor.execute(\"\"\"","                INSERT OR REPLACE INTO url_classifications (","                    url, domain, risk_score, category,","                    indicators, action, accessed_by, first_seen, last_seen","                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)","            \"\"\", (","                url_data.get('url'),","                url_data.get('domain'),","                url_data.get('risk_score'),","                url_data.get('category'),","                json.dumps(url_data.get('indicators', [])),","                url_data.get('action'),","                json.dumps(url_data.get('accessed_by', [])),","                datetime.now().isoformat(),","                datetime.now().isoformat()","            ))","        ","        # Store threat patterns","        for pattern in ai_response.get('behavior_patterns', []):","            cursor.execute(\"\"\"","                INSERT INTO threat_patterns (","                    pattern_type, device_ip, confidence, description,","                    first_detected, last_detected, severity","                ) VALUES (?, ?, ?, ?, ?, ?, ?)","            \"\"\", (","                pattern.get('pattern_type'),","                pattern.get('device_ip'),","                pattern.get('confidence'),","                pattern.get('description'),","                datetime.now().isoformat(),","                datetime.now().isoformat(),","                'HIGH' if pattern.get('confidence', 0) > 0.8 else 'MEDIUM'","            ))","        ","        # Store analysis history","        cursor.execute(\"\"\"","            INSERT INTO ai_analysis_history (","                timestamp, packets_analyzed, threats_found,","                alerts_generated, analysis_duration_ms, success","            ) VALUES (?, ?, ?, ?, ?, ?)","        \"\"\", (","            datetime.now().isoformat(),","            ai_response.get('statistics', {}).get('packets_analyzed', 0),","            ai_response.get('statistics', {}).get('threats_found', 0),","            len(ai_response.get('alerts', [])),","            ai_response.get('statistics', {}).get('processing_time_ms', 0),","            1","        ))","        ","        conn.commit()","        ","        model_used = ai_response.get('ai_model_used', 'Unknown')","        logging.info(f\"‚úì Stored AI results from {model_used}\")","        ","        return True","        ","    except Exception as e:","        logging.error(f\"Error storing AI predictions: {e}\")","        conn.rollback()","        return False","    finally:","        conn.close()","","","def analyze_network():","    \"\"\"Main function: Aggregate data, analyze with AI, store results\"\"\"","    ","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - Comprehensive AI Analysis\")","    logging.info(\"=\" * 60)","    ","    # Load configuration","    config = load_config()","    ","    if not config:","        logging.error(\"Failed to load configuration\")","        return False","    ","    # Check if AI is enabled","    if not config.get('ai_enabled', False):","        logging.info(\"AI analysis is disabled in configuration\")","        logging.info(f\"Edit {CONFIG_PATH} and set ai_enabled: true\")","        return False","    ","    # Aggregate data from all tools","    logging.info(\"Step 1: Aggregating data from all monitoring tools...\")","    aggregated_data = aggregate_all_data(config)","    ","    if aggregated_data['overall_statistics']['total_data_points'] == 0:","        logging.warning(\"No data to analyze\")","        return False","    ","    # Export for AI","    export_file, data = export_for_ai(aggregated_data)","    ","    # Create AI analyzer","    analyzer = MultiAIAnalyzer(config)","    ","    # Analyze with AI","    logging.info(\"Step 2: Analyzing with AI models...\")","    ai_response = analyzer.analyze_network_data(data)","    ","    if not ai_response:","        logging.warning(\"No response from any AI service\")","        return False","    ","    # Store results","    logging.info(\"Step 3: Storing AI predictions...\")","    success = store_ai_predictions(ai_response)","    ","    if success:","        logging.info(\"=\" * 60)","        logging.info(\"‚úÖ Comprehensive AI Analysis Complete!\")","        logging.info(f\"   Model Used: {ai_response.get('ai_model_used', 'Unknown')}\")","        logging.info(f\"   Threat Level: {ai_response.get('overall_threat_level')}\")","        logging.info(f\"   Health Score: {ai_response.get('network_health_score')}/100\")","        logging.info(f\"   Threats: {len(ai_response.get('threats_detected', []))}\")","        logging.info(f\"   Alerts: {len(ai_response.get('alerts', []))}\")","        logging.info(f\"   Suricata Alerts Processed: {ai_response.get('statistics', {}).get('suricata_alerts_processed', 0)}\")","        logging.info(\"=\" * 60)","    ","    return success","","","if __name__ == \"__main__\":","    success = analyze_network()","    ","    if not success:","        logging.info(\"\\n‚ÑπÔ∏è  Configure API keys in:\")","        logging.info(f\"   {CONFIG_PATH}\")","        logging.info(\"\\n   Edit the file and replace YOUR_GEMINI_KEY_HERE with your actual key\")","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000004,1000011,1000012,1000004,1000013,1000014,1000015,1000016,1000004,1000004,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000028,1000035,1000036,1000037,1000038,1000039,1000034,1000028,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000019,1000047,1000048,1000024,1000049,1000024,1000050,1000051,1000052,1000053,1000054,1000055,1000052,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000058,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000055,1000024,1000074,1000075,1000019,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000024,1000078,1000083,1000084,1000052,1000085,1000052,1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000052,1000093,1000052,1000094,1000095,1000082,1000019,1000096,1000097,1000078,1000098,1000080,1000099,1000082,1000024,1000078,1000100,1000052,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000108,1000109,1000092,1000052,1000110,1000052,1000094,1000111,1000082,1000019,1000112,1000113,1000078,1000114,1000080,1000115,1000082,1000024,1000078,1000116,1000117,1000118,1000092,1000052,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000119,1000092,1000052,1000110,1000052,1000094,1000120,1000082,1000019,1000121,1000122,1000024,1000123,1000124,1000125,1000126,1000127,1000024,1000128,1000004,1000129,1000004,1000130,1000131,1000132,1000133,1000004,1000134,1000135,1000136,1000137,1000138,1000004,1000139,1000140,1000004,1000141,1000142,1000004,1000143,1000004,1000144,1000145,1000146,1000147,1000148,1000004,1000149,1000150,1000151,1000152,1000153,1000004,1000154,1000155,1000156,1000157,1000004,1000158,1000159,1000160,1000004,1000161,1000004,1000162,1000163,1000164,1000165,1000166,1000167,1000168,1000169,1000170,1000171,1000172,1000173,1000174,1000175,1000176,1000177,1000178,1000179,1000180,1000181,1000182,1000183,1000184,1000185,1000186,1000173,1000187,1000188,1000189,1000190,1000184,1000185,1000191,1000173,1000192,1000193,1000194,1000195,1000196,1000197,1000184,1000185,1000198,1000173,1000199,1000176,1000187,1000200,1000184,1000185,1000201,1000173,1000202,1000203,1000204,1000205,1000206,1000178,1000176,1000207,1000208,1000184,1000185,1000209,1000210,1000211,1000212,1000213,1000214,1000215,1000216,1000004,1000217,1000001,1000024,1000218,1000019,1000219,1000220,1000221,1000024,1000222,1000223,1000224,1000225,1000024,1000078,1000226,1000227,1000228,1000229,1000082,1000004,1000004,1000230,1000231,1000232,1000233,1000019,1000234,1000235,1000019,1000236,1000237,1000238,1000239,1000240,1000241,1000242,1000243,1000244,1000245,1000246,1000247,1000248,1000249,1000250,1000251,1000252,1000253,1000254,1000255,1000256,1000024,1000257,1000258,1000259,1000260,1000261,1000262,1000263,1000264,1000265,1000266,1000267,1000268,1000269,1000270,1000271,1000272,1000273,1000274,1000275,1000276,1000024,1000277,1000278,1000259,1000279,1000280,1000281,1000282,1000265,1000283,1000284,1000285,1000286,1000287,1000288,1000289,1000290,1000275,1000276,1000024,1000291,1000292,1000259,1000293,1000294,1000295,1000296,1000265,1000297,1000298,1000299,1000300,1000290,1000290,1000301,1000276,1000024,1000302,1000238,1000303,1000304,1000305,1000306,1000244,1000307,1000308,1000309,1000251,1000310,1000311,1000256,1000024,1000312,1000024,1000313,1000314,1000024,1000315,1000024,1000316,1000317,1000318,1000233,1000319,1000320,1000004,1000004,1000321,1000322,1000019,1000323,1000324,1000323,1000019,1000325,1000326,1000019,1000327,1000328,1000233,1000019,1000329,1000330,1000331,1000332,1000233,1000019,1000333,1000334,1000335,1000019,1000336,1000337,1000233,1000019,1000338,1000339,1000019,1000340,1000341,1000019,1000342,1000343,1000344,1000019,1000232,1000345,1000233,1000019,1000346,1000347,1000348,1000019,1000349,1000350,1000351,1000352,1000353,1000354,1000355,1000356,1000357,1000350,1000019,1000358,1000004,1000004,1000359,1000360,1000019,1000361,1000362,1000363,1000364,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}