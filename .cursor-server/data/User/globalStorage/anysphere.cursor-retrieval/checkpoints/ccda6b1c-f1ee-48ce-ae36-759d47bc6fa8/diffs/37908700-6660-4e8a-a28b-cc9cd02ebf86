{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\unified_device_processor.py","fileUuid":"37908700-6660-4e8a-a28b-cc9cd02ebf86","fileSizeBytes":4860,"numLines":155,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":156,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - Unified Device Processor","Processes ALL network traffic to track devices and update device database","Runs continuously to ensure real-time device discovery","\"\"\"","","import sqlite3","import logging","import time","import sys","from datetime import datetime","from device_tracker import DeviceTracker","","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/unified-device-processor.log\"","PROCESS_INTERVAL = 30  # Process every 30 seconds","","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","def get_latest_table(conn, prefix):","    \"\"\"Get most recent table for a tool\"\"\"","    cursor = conn.cursor()","    cursor.execute(f\"\"\"","        SELECT name FROM sqlite_master ","        WHERE type='table' AND name LIKE '{prefix}_%' ","        AND name NOT LIKE '%_template'","        ORDER BY name DESC LIMIT 1","    \"\"\")","    result = cursor.fetchone()","    return result[0] if result else None","","def process_traffic_data():","    \"\"\"Process all traffic data and update device tracker\"\"\"","    tracker = DeviceTracker()","    ","    try:","        conn = sqlite3.connect(DB_PATH)","        conn.row_factory = sqlite3.Row","        cursor = conn.cursor()","        ","        devices_updated = 0","        ","        # Get all unique LOCAL IPs from recent traffic (only 192.168.x.x)","        local_ips = set()","        ","        # Process tcpdump data (most comprehensive)","        tcpdump_table = get_latest_table(conn, 'tcpdump')","        if tcpdump_table:","            # Get unique local source IPs","            cursor.execute(f\"\"\"","                SELECT DISTINCT src_ip ","                FROM {tcpdump_table}","                WHERE src_ip LIKE '192.168.%'","                LIMIT 500","            \"\"\")","            for row in cursor.fetchall():","                if row['src_ip']:","                    local_ips.add(row['src_ip'])","            ","            # Get unique local dest IPs","            cursor.execute(f\"\"\"","                SELECT DISTINCT dest_ip ","                FROM {tcpdump_table}","                WHERE dest_ip LIKE '192.168.%'","                LIMIT 500","            \"\"\")","            for row in cursor.fetchall():","                if row['dest_ip']:","                    local_ips.add(row['dest_ip'])","        ","        # Process tshark data","        tshark_table = get_latest_table(conn, 'tshark')","        if tshark_table:","            cursor.execute(f\"\"\"","                SELECT DISTINCT src_ip ","                FROM {tshark_table}","                WHERE src_ip LIKE '192.168.%'","                LIMIT 500","            \"\"\")","            for row in cursor.fetchall():","                if row['src_ip']:","                    local_ips.add(row['src_ip'])","            ","            cursor.execute(f\"\"\"","                SELECT DISTINCT dest_ip ","                FROM {tshark_table}","                WHERE dest_ip LIKE '192.168.%'","                LIMIT 500","            \"\"\")","            for row in cursor.fetchall():","                if row['dest_ip']:","                    local_ips.add(row['dest_ip'])","        ","        conn.close()","        ","        # Also scan ARP table first to get MACs","        arp_devices = tracker.scan_network()","        ","        # Now process all unique local IPs (will match to ARP-discovered MACs)","        logging.info(f\"Found {len(local_ips)} unique local IPs in traffic\")","        for ip in local_ips:","            tracker.update_device(ip_address=ip)","            devices_updated += 1","        ","        logging.info(f\"✓ Processed traffic data: {devices_updated} local device updates, {arp_devices} from ARP\")","        ","        return devices_updated + arp_devices","        ","    except Exception as e:","        logging.error(f\"Error processing traffic data: {e}\")","        return 0","","def main():","    \"\"\"Main continuous processing loop\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - Unified Device Processor\")","    logging.info(\"=\" * 60)","    logging.info(f\"Processing interval: {PROCESS_INTERVAL} seconds\")","    logging.info(\"Starting continuous device tracking...\\n\")","    ","    cycle = 0","    ","    try:","        while True:","            cycle += 1","            logging.info(f\"--- Processing Cycle {cycle} ---\")","            ","            device_count = process_traffic_data()","            ","            if device_count > 0:","                logging.info(f\"✓ Cycle {cycle} complete: {device_count} devices tracked\")","            else:","                logging.info(f\"ℹ Cycle {cycle}: No new device data\")","            ","            time.sleep(PROCESS_INTERVAL)","            ","    except KeyboardInterrupt:","        logging.info(\"\\n✓ Shutdown signal received\")","        return 0","    except Exception as e:","        logging.error(f\"Fatal error: {e}\")","        return 1","","if __name__ == \"__main__\":","    sys.exit(main())","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000001,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000005,1000012,1000013,1000014,1000005,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000005,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000005,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000042,1000044,1000045,1000042,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000050,1000061,1000052,1000062,1000054,1000055,1000056,1000063,1000064,1000042,1000065,1000066,1000067,1000050,1000051,1000068,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000050,1000061,1000068,1000062,1000054,1000055,1000056,1000063,1000064,1000042,1000069,1000042,1000070,1000071,1000042,1000072,1000073,1000074,1000075,1000076,1000042,1000077,1000042,1000078,1000042,1000079,1000080,1000081,1000005,1000082,1000083,1000084,1000085,1000084,1000086,1000087,1000037,1000088,1000037,1000038,1000089,1000090,1000091,1000059,1000092,1000059,1000093,1000094,1000095,1000096,1000059,1000097,1000059,1000098,1000099,1000081,1000079,1000100,1000101,1000005,1000102,1000103,1000005,1000005]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}