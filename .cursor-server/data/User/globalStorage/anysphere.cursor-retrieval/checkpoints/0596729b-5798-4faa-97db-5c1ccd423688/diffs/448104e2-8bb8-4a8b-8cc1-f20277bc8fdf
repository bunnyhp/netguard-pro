{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\device_scorer.py","fileUuid":"448104e2-8bb8-4a8b-8cc1-f20277bc8fdf","fileSizeBytes":9614,"numLines":251,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":252,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - Device Security Scorer","Calculates security scores (0-100) for all tracked devices","\"\"\"","","import sqlite3","import logging","import sys","from datetime import datetime, timedelta","","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/device-scorer.log\"","","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","class DeviceScorer:","    \"\"\"Calculate security scores for devices based on multiple factors\"\"\"","    ","    def __init__(self):","        self.conn = sqlite3.connect(DB_PATH)","        self.conn.row_factory = sqlite3.Row","        self.cursor = self.conn.cursor()","    ","    def calculate_device_score(self, device):","        \"\"\"Calculate security score for a single device (0-100)\"\"\"","        score = 100  # Start with perfect score","        reasons = []","        ","        # Factor 1: Device Identification (-20 if unknown)","        if not device['hostname'] or device['hostname'] == '':","            score -= 10","            reasons.append(\"No hostname resolution (-10)\")","        ","        if not device['mac_address']:","            score -= 15","            reasons.append(\"No MAC address identified (-15)\")","        ","        if device['device_type'] == 'Unknown':","            score -= 10","            reasons.append(\"Unknown device type (-10)\")","        ","        # Factor 2: Vulnerabilities (check iot_vulnerabilities table)","        self.cursor.execute(\"\"\"","            SELECT COUNT(*) as vuln_count,","                   MAX(CASE severity","                       WHEN 'CRITICAL' THEN 4","                       WHEN 'HIGH' THEN 3","                       WHEN 'MEDIUM' THEN 2","                       WHEN 'LOW' THEN 1","                       ELSE 0","                   END) as max_severity","            FROM iot_vulnerabilities","            WHERE device_ip = ? AND resolved = 0","        \"\"\", (device['ip_address'],))","        ","        vuln_result = self.cursor.fetchone()","        if vuln_result and vuln_result['vuln_count'] > 0:","            vuln_count = vuln_result['vuln_count']","            max_severity = vuln_result['max_severity']","            ","            if max_severity == 4:  # CRITICAL","                score -= 40","                reasons.append(f\"Critical vulnerabilities detected ({vuln_count}) (-40)\")","            elif max_severity == 3:  # HIGH","                score -= 25","                reasons.append(f\"High severity vulnerabilities ({vuln_count}) (-25)\")","            elif max_severity == 2:  # MEDIUM","                score -= 15","                reasons.append(f\"Medium severity vulnerabilities ({vuln_count}) (-15)\")","            elif max_severity == 1:  # LOW","                score -= 5","                reasons.append(f\"Low severity vulnerabilities ({vuln_count}) (-5)\")","        ","        # Factor 3: Network Activity (check for suspicious connections)","        # Check recent traffic for unencrypted HTTP","        try:","            self.cursor.execute(\"\"\"","                SELECT name FROM sqlite_master ","                WHERE type='table' AND (name LIKE 'tshark_%' OR name LIKE 'tcpdump_%')","                AND name NOT LIKE '%_template'","                ORDER BY name DESC LIMIT 1","            \"\"\")","            table_result = self.cursor.fetchone()","            ","            if table_result:","                table_name = table_result['name']","                ","                # Check HTTP vs HTTPS ratio","                self.cursor.execute(f\"\"\"","                    SELECT ","                        COUNT(CASE WHEN dest_port = 80 THEN 1 END) as http_count,","                        COUNT(CASE WHEN dest_port = 443 THEN 1 END) as https_count","                    FROM {table_name}","                    WHERE src_ip = ?","                    AND dest_port IN (80, 443)","                \"\"\", (device['ip_address'],))","                ","                traffic_result = self.cursor.fetchone()","                if traffic_result:","                    http_count = traffic_result['http_count']","                    https_count = traffic_result['https_count']","                    total_web = http_count + https_count","                    ","                    if total_web > 10 and http_count > 0:","                        http_ratio = (http_count / total_web * 100)","                        if http_ratio > 70:","                            score -= 15","                            reasons.append(f\"High unencrypted traffic ({http_ratio:.0f}% HTTP) (-15)\")","                        elif http_ratio > 40:","                            score -= 8","                            reasons.append(f\"Moderate unencrypted traffic ({http_ratio:.0f}% HTTP) (-8)\")","        except Exception as e:","            logging.debug(f\"Error checking traffic for {device['ip_address']}: {e}\")","        ","        # Factor 4: Device Activity (last seen)","        if device['last_seen']:","            last_seen = datetime.fromisoformat(device['last_seen'])","            hours_inactive = (datetime.now() - last_seen).total_seconds() / 3600","            ","            if hours_inactive > 24:","                score -= 5","                reasons.append(\"Device inactive >24 hours (-5)\")","        ","        # Factor 5: IoT Device Bonus/Penalty","        if device['device_type'] == 'IoT':","            # IoT devices are inherently riskier","            score -= 5","            reasons.append(\"IoT device (inherent risk) (-5)\")","            ","            # But if it's properly categorized, give back some points","            if device['device_category'] and device['device_category'] != 'Unknown':","                score += 3","                reasons.append(\"Properly categorized (+3)\")","        ","        # Factor 6: Network Device Security","        if device['device_type'] == 'Network':","            # Routers/switches are critical infrastructure","            score += 10","            reasons.append(\"Network infrastructure device (+10)\")","        ","        # Ensure score stays within bounds","        score = max(0, min(100, score))","        ","        return score, reasons","    ","    def update_all_scores(self):","        \"\"\"Update security scores for all devices\"\"\"","        logging.info(\"Calculating security scores for all devices...\")","        ","        self.cursor.execute(\"SELECT * FROM devices\")","        devices = self.cursor.fetchall()","        ","        updated_count = 0","        score_distribution = {'A': 0, 'B': 0, 'C': 0, 'D': 0, 'F': 0}","        ","        for device in devices:","            device_dict = dict(device)","            score, reasons = self.calculate_device_score(device_dict)","            ","            # Update the security score","            self.cursor.execute(\"\"\"","                UPDATE devices ","                SET security_score = ?","                WHERE ip_address = ?","            \"\"\", (score, device_dict['ip_address']))","            ","            updated_count += 1","            ","            # Track score distribution","            if score >= 90:","                score_distribution['A'] += 1","                grade = 'A'","            elif score >= 80:","                score_distribution['B'] += 1","                grade = 'B'","            elif score >= 70:","                score_distribution['C'] += 1","                grade = 'C'","            elif score >= 60:","                score_distribution['D'] += 1","                grade = 'D'","            else:","                score_distribution['F'] += 1","                grade = 'F'","            ","            logging.info(f\"  {device_dict['ip_address']:15s} | Score: {score:3d}/100 (Grade {grade}) | {device_dict['device_category'] or 'Unknown'}\")","            if reasons and score < 80:","                for reason in reasons[:3]:  # Show top 3 reasons","                    logging.info(f\"    - {reason}\")","        ","        self.conn.commit()","        ","        logging.info(f\"\\n✓ Updated {updated_count} device security scores\")","        logging.info(f\"Score Distribution: A={score_distribution['A']}, B={score_distribution['B']}, C={score_distribution['C']}, D={score_distribution['D']}, F={score_distribution['F']}\")","        ","        return updated_count, score_distribution","    ","    def get_at_risk_devices(self, threshold=60):","        \"\"\"Get devices with security score below threshold\"\"\"","        self.cursor.execute(\"\"\"","            SELECT ip_address, hostname, device_type, device_category, ","                   security_score, vendor","            FROM devices","            WHERE security_score < ?","            ORDER BY security_score ASC","        \"\"\", (threshold,))","        ","        return [dict(row) for row in self.cursor.fetchall()]","    ","    def close(self):","        \"\"\"Close database connection\"\"\"","        self.conn.close()","","def main():","    \"\"\"Main scoring function\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - Device Security Scorer\")","    logging.info(\"=\" * 60)","    ","    try:","        scorer = DeviceScorer()","        updated, distribution = scorer.update_all_scores()","        ","        # Show at-risk devices","        at_risk = scorer.get_at_risk_devices(threshold=70)","        if at_risk:","            logging.info(f\"\\n⚠️  {len(at_risk)} device(s) need attention (score < 70):\")","            for device in at_risk:","                logging.info(f\"  - {device['ip_address']:15s} ({device['hostname'] or 'Unknown'}): {device['security_score']}/100\")","        else:","            logging.info(\"\\n✓ All devices have acceptable security scores!\")","        ","        scorer.close()","        return 0","        ","    except Exception as e:","        logging.error(f\"Error during scoring: {e}\")","        return 1","","if __name__ == \"__main__\":","    sys.exit(main())","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000004,1000009,1000010,1000004,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000004,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000021,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000030,1000035,1000036,1000037,1000030,1000038,1000033,1000039,1000030,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000030,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000030,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000057,1000080,1000081,1000082,1000083,1000084,1000085,1000086,1000087,1000088,1000089,1000090,1000091,1000082,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000030,1000108,1000109,1000110,1000111,1000057,1000112,1000068,1000113,1000030,1000114,1000115,1000116,1000117,1000118,1000057,1000119,1000120,1000121,1000122,1000030,1000123,1000124,1000125,1000126,1000127,1000030,1000128,1000129,1000030,1000130,1000021,1000131,1000132,1000133,1000030,1000134,1000135,1000030,1000136,1000137,1000030,1000138,1000139,1000140,1000057,1000141,1000073,1000142,1000143,1000144,1000145,1000057,1000146,1000057,1000147,1000148,1000149,1000150,1000151,1000152,1000153,1000154,1000155,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000057,1000163,1000164,1000165,1000166,1000030,1000167,1000030,1000168,1000169,1000030,1000170,1000021,1000171,1000172,1000041,1000173,1000174,1000175,1000176,1000177,1000178,1000030,1000179,1000021,1000180,1000181,1000182,1000004,1000183,1000184,1000185,1000186,1000185,1000021,1000187,1000188,1000189,1000030,1000190,1000191,1000192,1000193,1000194,1000195,1000196,1000197,1000030,1000198,1000199,1000030,1000200,1000201,1000202,1000004,1000203,1000204,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}