{"fsPath":"\\home\\jarvis\\NetGuard\\web\\app.py","fileUuid":"6077d506-05bb-4d5d-8999-ce71adf0493a","fileSizeBytes":89677,"numLines":2222,"diffChanges":[{"originalStartLineNumberOneIndexed":998,"originalEndLineNumberExclusiveOneIndexed":998,"modifiedStartLineNumberOneIndexed":998,"modifiedEndLineNumberExclusiveOneIndexed":999,"addedLines":["    try:"],"tokenizedAddedLines":[34]},{"originalStartLineNumberOneIndexed":1001,"originalEndLineNumberExclusiveOneIndexed":1002,"modifiedStartLineNumberOneIndexed":1002,"modifiedEndLineNumberExclusiveOneIndexed":1007,"addedLines":["        # First, check if IoT security tables exist","        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name IN ('iot_vulnerabilities', 'iot_security_scores', 'iot_communications', 'iot_behavioral_data')\")","        existing_tables = [row['name'] for row in cursor.fetchall()]","        ","        # Get basic IoT devices first"],"tokenizedAddedLines":[1001331,1001332,1001333,47,1001334]},{"originalStartLineNumberOneIndexed":1003,"originalEndLineNumberExclusiveOneIndexed":1015,"modifiedStartLineNumberOneIndexed":1008,"modifiedEndLineNumberExclusiveOneIndexed":1009,"addedLines":["            SELECT * FROM devices "],"tokenizedAddedLines":[1001335]},{"originalStartLineNumberOneIndexed":1016,"originalEndLineNumberExclusiveOneIndexed":1028,"modifiedStartLineNumberOneIndexed":1010,"modifiedEndLineNumberExclusiveOneIndexed":1021,"addedLines":["                device_type = 'IoT' OR","                device_category LIKE '%camera%' OR","                device_category LIKE '%tv%' OR","                device_category LIKE '%speaker%' OR","                device_category LIKE '%thermostat%' OR","                device_category LIKE '%plug%' OR","                device_category LIKE '%sensor%' OR","                vendor IN ('Amazon', 'Google', 'Samsung', 'LG', 'Sony', 'TP-Link', 'Belkin', 'Netgear', 'D-Link')","            )","            AND last_seen > datetime('now', '-24 hours')","            ORDER BY last_seen DESC"],"tokenizedAddedLines":[1001336,1001337,1001338,1001339,1001340,1001341,1001342,1001343,1001344,1001345,1001346]},{"originalStartLineNumberOneIndexed":1033,"originalEndLineNumberExclusiveOneIndexed":1033,"modifiedStartLineNumberOneIndexed":1026,"modifiedEndLineNumberExclusiveOneIndexed":1042,"addedLines":["            device_ip = device['ip_address']","            ","            # Initialize default values","            device['vulnerabilities'] = {'count': 0, 'max_severity': 0}","            device['security_score'] = 50  # Default score","            device['total_packets'] = 0","            ","            # Add vulnerability data if table exists","            if 'iot_vulnerabilities' in existing_tables:","                cursor.execute(\"\"\"","                    SELECT COUNT(*) as vuln_count, MAX(severity) as max_severity","                    FROM iot_vulnerabilities","                    WHERE device_ip = ? AND resolved = 0","                \"\"\", (device_ip,))","                vuln_result = cursor.fetchone()","                if vuln_result:"],"tokenizedAddedLines":[1001347,187,1001348,1001349,1001350,1001351,187,1001352,1001353,1001354,1001355,1001356,1001357,1001358,1001359,1001360]},{"originalStartLineNumberOneIndexed":1034,"originalEndLineNumberExclusiveOneIndexed":1038,"modifiedStartLineNumberOneIndexed":1043,"modifiedEndLineNumberExclusiveOneIndexed":1066,"addedLines":["                        'count': vuln_result['vuln_count'] or 0,","                        'max_severity': vuln_result['max_severity'] or 0","                    }","            ","            # Add security score if table exists","            if 'iot_security_scores' in existing_tables:","                cursor.execute(\"\"\"","                    SELECT overall_score FROM iot_security_scores WHERE device_ip = ?","                \"\"\", (device_ip,))","                score_result = cursor.fetchone()","                if score_result:","                    device['security_score'] = score_result['overall_score']","            ","            # Add communication count if table exists","            if 'iot_communications' in existing_tables:","                cursor.execute(\"\"\"","                    SELECT COUNT(*) as comm_count FROM iot_communications ","                    WHERE device_ip = ? AND timestamp > datetime('now', '-1 hour')","                \"\"\", (device_ip,))","                comm_result = cursor.fetchone()","                if comm_result:","                    device['total_packets'] = comm_result['comm_count'] or 0","            "],"tokenizedAddedLines":[1001361,1001362,1001363,187,1001364,1001365,1001354,1001366,1001358,1001367,1001368,1001369,187,1001370,1001371,1001354,1001372,1001373,1001358,1001374,1001375,1001376,187]},{"originalStartLineNumberOneIndexed":1043,"originalEndLineNumberExclusiveOneIndexed":1043,"modifiedStartLineNumberOneIndexed":1071,"modifiedEndLineNumberExclusiveOneIndexed":1085,"addedLines":["        ","    except Exception as e:","        logging.error(f\"Error in IoT devices route: {e}\")","        # Fallback to basic device list","        conn = get_db_connection()","        cursor = conn.cursor()","        cursor.execute(\"SELECT * FROM devices WHERE device_type = 'IoT' ORDER BY last_seen DESC\")","        devices = [dict(row) for row in cursor.fetchall()]","        for device in devices:","            device['vulnerabilities'] = {'count': 0, 'max_severity': 0}","            device['security_score'] = 50","            device['total_packets'] = 0","        conn.close()","        return render_template('iot_devices.html', devices=devices)"],"tokenizedAddedLines":[47,53,1001377,1001378,35,36,1001379,1001380,1001381,1001349,1001382,1001351,39,1001383]},{"originalStartLineNumberOneIndexed":1073,"originalEndLineNumberExclusiveOneIndexed":1073,"modifiedStartLineNumberOneIndexed":1115,"modifiedEndLineNumberExclusiveOneIndexed":1116,"addedLines":["    try:"],"tokenizedAddedLines":[34]},{"originalStartLineNumberOneIndexed":1076,"originalEndLineNumberExclusiveOneIndexed":1076,"modifiedStartLineNumberOneIndexed":1119,"modifiedEndLineNumberExclusiveOneIndexed":1126,"addedLines":["        # Check if iot_domain_patterns table exists","        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='iot_domain_patterns'\")","        table_exists = cursor.fetchone() is not None","        ","        communications = []","        ","        if table_exists:"],"tokenizedAddedLines":[1001384,1001385,1001386,47,1001387,47,1001388]},{"originalStartLineNumberOneIndexed":1086,"originalEndLineNumberExclusiveOneIndexed":1088,"modifiedStartLineNumberOneIndexed":1136,"modifiedEndLineNumberExclusiveOneIndexed":1137,"addedLines":["                    dp.risk_level"],"tokenizedAddedLines":[1001389]},{"originalStartLineNumberOneIndexed":1089,"originalEndLineNumberExclusiveOneIndexed":1091,"modifiedStartLineNumberOneIndexed":1138,"modifiedEndLineNumberExclusiveOneIndexed":1139,"addedLines":["                LEFT JOIN devices d ON dp.device_ip = d.ip_address"],"tokenizedAddedLines":[1001390]},{"originalStartLineNumberOneIndexed":1095,"originalEndLineNumberExclusiveOneIndexed":1096,"modifiedStartLineNumberOneIndexed":1143,"modifiedEndLineNumberExclusiveOneIndexed":1143},{"originalStartLineNumberOneIndexed":1098,"originalEndLineNumberExclusiveOneIndexed":1099,"modifiedStartLineNumberOneIndexed":1145,"modifiedEndLineNumberExclusiveOneIndexed":1146,"addedLines":["                device_name = f\"{device_info['hostname'] or device_info['device_category'] or 'Unknown Device'} ({device_info['device_ip']})\""],"tokenizedAddedLines":[1001391]},{"originalStartLineNumberOneIndexed":1108,"originalEndLineNumberExclusiveOneIndexed":1109,"modifiedStartLineNumberOneIndexed":1155,"modifiedEndLineNumberExclusiveOneIndexed":1156,"addedLines":["                    'firstSeen': device_info['first_seen'].split(' ')[0] if device_info['first_seen'] else 'Unknown',"],"tokenizedAddedLines":[1001392]},{"originalStartLineNumberOneIndexed":1110,"originalEndLineNumberExclusiveOneIndexed":1111,"modifiedStartLineNumberOneIndexed":1157,"modifiedEndLineNumberExclusiveOneIndexed":1179,"addedLines":["                    'riskLevel': risk_text","                })","        else:","            # Fallback to basic device info if table doesn't exist yet","            cursor.execute(\"\"\"","                SELECT ip_address, hostname, device_category","                FROM devices ","                WHERE device_type = 'IoT'","                LIMIT 10","            \"\"\")","            ","            for row in cursor.fetchall():","                device_info = dict(row)","                device_name = f\"{device_info['hostname'] or device_info['device_category'] or 'Unknown Device'} ({device_info['ip_address']})\"","                ","                communications.append({","                    'device': device_name,","                    'domain': 'example.com',","                    'frequency': 'Low',","                    'firstSeen': '2024-01-01',","                    'lastSeen': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),","                    'riskLevel': 'Safe'"],"tokenizedAddedLines":[1001393,1001394,912,1001395,188,1001396,190,1001397,197,193,187,1001398,1001399,1001400,82,1001401,1001402,1001403,1001404,1001405,1001406,1001407]},{"originalStartLineNumberOneIndexed":1115,"originalEndLineNumberExclusiveOneIndexed":1115,"modifiedStartLineNumberOneIndexed":1183,"modifiedEndLineNumberExclusiveOneIndexed":1187,"addedLines":["        ","    except Exception as e:","        logging.error(f\"Error in domain communications: {e}\")","        return jsonify([])"],"tokenizedAddedLines":[47,53,1001408,1001409]},{"originalStartLineNumberOneIndexed":1120,"originalEndLineNumberExclusiveOneIndexed":1120,"modifiedStartLineNumberOneIndexed":1192,"modifiedEndLineNumberExclusiveOneIndexed":1193,"addedLines":["    try:"],"tokenizedAddedLines":[34]},{"originalStartLineNumberOneIndexed":1141,"originalEndLineNumberExclusiveOneIndexed":1142,"modifiedStartLineNumberOneIndexed":1214,"modifiedEndLineNumberExclusiveOneIndexed":1226,"addedLines":["        # Initialize defaults","        secure_devices = total_devices","        vulnerable_devices = 0","        domains_tracked = 0","        active_alerts = 0","        ","        # Check if IoT security tables exist","        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name IN ('iot_vulnerabilities', 'iot_domain_patterns', 'iot_security_alerts')\")","        existing_tables = [row['name'] for row in cursor.fetchall()]","        ","        # Get secure devices (no vulnerabilities) if table exists","        if 'iot_vulnerabilities' in existing_tables:"],"tokenizedAddedLines":[1001410,1001411,1001412,1001413,1001414,47,1001415,1001416,1001333,47,1001417,1001418]},{"originalStartLineNumberOneIndexed":1159,"originalEndLineNumberExclusiveOneIndexed":1160,"modifiedStartLineNumberOneIndexed":1243,"modifiedEndLineNumberExclusiveOneIndexed":1246,"addedLines":["            result = cursor.fetchone()","            if result:","                secure_devices = result['secure_devices']"],"tokenizedAddedLines":[1001419,1001420,1001421]},{"originalStartLineNumberOneIndexed":1178,"originalEndLineNumberExclusiveOneIndexed":1179,"modifiedStartLineNumberOneIndexed":1264,"modifiedEndLineNumberExclusiveOneIndexed":1267,"addedLines":["            result = cursor.fetchone()","            if result:","                vulnerable_devices = result['vulnerable_devices']"],"tokenizedAddedLines":[1001419,1001420,1001422]},{"originalStartLineNumberOneIndexed":1180,"originalEndLineNumberExclusiveOneIndexed":1181,"modifiedStartLineNumberOneIndexed":1268,"modifiedEndLineNumberExclusiveOneIndexed":1270,"addedLines":["        # Get domains tracked if table exists","        if 'iot_domain_patterns' in existing_tables:"],"tokenizedAddedLines":[1001423,1001424]},{"originalStartLineNumberOneIndexed":1182,"originalEndLineNumberExclusiveOneIndexed":1183,"modifiedStartLineNumberOneIndexed":1271,"modifiedEndLineNumberExclusiveOneIndexed":1274,"addedLines":["            result = cursor.fetchone()","            if result:","                domains_tracked = result['domains_tracked']"],"tokenizedAddedLines":[1001419,1001420,1001425]},{"originalStartLineNumberOneIndexed":1184,"originalEndLineNumberExclusiveOneIndexed":1185,"modifiedStartLineNumberOneIndexed":1275,"modifiedEndLineNumberExclusiveOneIndexed":1277,"addedLines":["        # Get active alerts if table exists","        if 'iot_security_alerts' in existing_tables:"],"tokenizedAddedLines":[1001426,1001427]},{"originalStartLineNumberOneIndexed":1186,"originalEndLineNumberExclusiveOneIndexed":1187,"modifiedStartLineNumberOneIndexed":1278,"modifiedEndLineNumberExclusiveOneIndexed":1281,"addedLines":["            result = cursor.fetchone()","            if result:","                active_alerts = result['active_alerts']"],"tokenizedAddedLines":[1001419,1001420,1001428]},{"originalStartLineNumberOneIndexed":1198,"originalEndLineNumberExclusiveOneIndexed":1200,"modifiedStartLineNumberOneIndexed":1292,"modifiedEndLineNumberExclusiveOneIndexed":1309,"addedLines":["            'domains_count': domains_tracked,","            'alerts_count': active_alerts","        })","        ","    except Exception as e:","        logging.error(f\"Error in security stats: {e}\")","        # Return safe defaults","        return jsonify({","            'totalDevices': 0,","            'secureDevices': 0,","            'vulnerableDevices': 0,","            'monitoringDevices': 0,","            'domainsTracked': 0,","            'activeAlerts': 0,","            'monitoring_count': 0,","            'domains_count': 0,","            'alerts_count': 0"],"tokenizedAddedLines":[1001429,1001430,362,47,53,1001431,1001432,1030,1001433,1001434,1001435,1001436,1001437,1001438,1001439,1001440,1001441]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}