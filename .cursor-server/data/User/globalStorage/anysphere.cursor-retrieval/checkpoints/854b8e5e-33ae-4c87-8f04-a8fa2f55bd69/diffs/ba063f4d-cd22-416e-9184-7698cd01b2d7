{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\ai_service_connector.py","fileUuid":"ba063f4d-cd22-416e-9184-7698cd01b2d7","fileSizeBytes":23171,"numLines":653,"diffChanges":[{"originalStartLineNumberOneIndexed":3,"originalEndLineNumberExclusiveOneIndexed":8,"modifiedStartLineNumberOneIndexed":3,"modifiedEndLineNumberExclusiveOneIndexed":9,"addedLines":["NetGuard Pro - Multi-AI Service Connector","Supports multiple free AI APIs with automatic fallback","Primary: Google Gemini 2.0 Flash","Fallbacks: Groq, OpenRouter (DeepSeek, Qwen, etc.)","\"\"\"",""],"tokenizedAddedLines":[1000211,1000212,1000213,1000214,2,5]},{"originalStartLineNumberOneIndexed":11,"originalEndLineNumberExclusiveOneIndexed":11,"modifiedStartLineNumberOneIndexed":12,"modifiedEndLineNumberExclusiveOneIndexed":13,"addedLines":["import re"],"tokenizedAddedLines":[1000215]},{"originalStartLineNumberOneIndexed":21,"originalEndLineNumberExclusiveOneIndexed":21,"modifiedStartLineNumberOneIndexed":23,"modifiedEndLineNumberExclusiveOneIndexed":422,"addedLines":["","class MultiAIAnalyzer:","    \"\"\"","    Multi-provider AI analyzer with automatic fallback","    Supports: Gemini, Groq, OpenRouter (DeepSeek, Qwen)","    \"\"\"","    ","    def __init__(self, config):","        self.config = config","        self.models = self._load_model_configs()","        ","    def _load_model_configs(self):","        \"\"\"Load AI model configurations in priority order\"\"\"","        return [","            # PRIMARY: Google Gemini 2.0 Flash","            {","                'name': 'Gemini 2.0 Flash',","                'provider': 'gemini',","                'model': 'gemini-2.0-flash-exp',","                'api_key_name': 'gemini_api_key',","                'priority': 1,","                'enabled': True","            },","            ","            # FALLBACK 1: Groq Llama 3.3 70B","            {","                'name': 'Groq Llama 3.3 70B',","                'provider': 'groq',","                'model': 'llama-3.3-70b-versatile',","                'api_key_name': 'groq_api_key',","                'priority': 2,","                'enabled': True","            },","            ","            # FALLBACK 2: Groq Kimi K2","            {","                'name': 'Groq Kimi K2',","                'provider': 'groq',","                'model': 'kimi-k2',","                'api_key_name': 'groq_api_key',","                'priority': 3,","                'enabled': True","            },","            ","            # FALLBACK 3: OpenRouter DeepSeek R1","            {","                'name': 'DeepSeek R1 (Qwen 8B)',","                'provider': 'openrouter',","                'model': 'deepseek/deepseek-r1-0528-qwen3-8b',","                'api_key_name': 'openrouter_api_key',","                'priority': 4,","                'enabled': True","            },","            ","            # FALLBACK 4: OpenRouter Qwen Coder 480B","            {","                'name': 'Qwen 3 Coder 480B',","                'provider': 'openrouter',","                'model': 'qwen/qwen-3-coder-480b',","                'api_key_name': 'openrouter_api_key',","                'priority': 5,","                'enabled': True","            },","            ","            # FALLBACK 5: OpenRouter DeepSeek V3.1","            {","                'name': 'DeepSeek V3.1',","                'provider': 'openrouter',","                'model': 'deepseek/deepseek-v3-1',","                'api_key_name': 'openrouter_api_key',","                'priority': 6,","                'enabled': True","            },","            ","            # FALLBACK 6: Groq Llama 3.1 70B","            {","                'name': 'Groq Llama 3.1 70B',","                'provider': 'groq',","                'model': 'llama-3.1-70b-versatile',","                'api_key_name': 'groq_api_key',","                'priority': 7,","                'enabled': True","            },","            ","            # FALLBACK 7: OpenRouter Llama 3.1 405B","            {","                'name': 'Meta Llama 3.1 405B',","                'provider': 'openrouter',","                'model': 'meta-llama/llama-3.1-405b',","                'api_key_name': 'openrouter_api_key',","                'priority': 8,","                'enabled': True","            }","        ]","    ","    def analyze_network_data(self, network_data):","        \"\"\"","        Analyze network data using available AI models","        Tries each model in priority order until success","        \"\"\"","        ","        logging.info(f\"Starting AI analysis with {len(self.models)} available models\")","        ","        for model_config in self.models:","            if not model_config['enabled']:","                continue","                ","            # Get API key from config","            api_key = self.config.get(model_config['api_key_name'])","            ","            if not api_key or api_key == 'YOUR_API_KEY_HERE':","                logging.debug(f\"‚è≠Ô∏è  Skipping {model_config['name']} (no API key)\")","                continue","            ","            try:","                logging.info(f\"ü§ñ Trying {model_config['name']}...\")","                ","                # Call appropriate provider","                if model_config['provider'] == 'gemini':","                    result = self._call_gemini(network_data, model_config, api_key)","                elif model_config['provider'] == 'groq':","                    result = self._call_groq(network_data, model_config, api_key)","                elif model_config['provider'] == 'openrouter':","                    result = self._call_openrouter(network_data, model_config, api_key)","                else:","                    logging.warning(f\"Unknown provider: {model_config['provider']}\")","                    continue","                ","                if result:","                    logging.info(f\"‚úÖ Success with {model_config['name']}!\")","                    result['ai_model_used'] = model_config['name']","                    return result","                    ","            except Exception as e:","                logging.warning(f\"‚ùå {model_config['name']} failed: {str(e)[:100]}\")","                continue","        ","        logging.error(\"‚ùå All AI models failed or no API keys configured\")","        return None","    ","    def _call_gemini(self, data, config, api_key):","        \"\"\"Call Google Gemini API\"\"\"","        try:","            import google.generativeai as genai","        except ImportError:","            logging.error(\"google-generativeai not installed. Run: pip install google-generativeai\")","            return None","        ","        try:","            genai.configure(api_key=api_key)","            model = genai.GenerativeModel(config['model'])","            ","            prompt = self._build_prompt(data)","            ","            response = model.generate_content(","                prompt,","                generation_config={","                    'temperature': 0.3,","                    'max_output_tokens': 4096,","                }","            )","            ","            return self._parse_json_response(response.text)","            ","        except Exception as e:","            logging.error(f\"Gemini error: {e}\")","            return None","    ","    def _call_groq(self, data, config, api_key):","        \"\"\"Call Groq API (Llama, Kimi, etc.)\"\"\"","        try:","            from groq import Groq","        except ImportError:","            logging.error(\"groq not installed. Run: pip install groq\")","            return None","        ","        try:","            client = Groq(api_key=api_key)","            ","            response = client.chat.completions.create(","                model=config['model'],","                messages=[","                    {","                        \"role\": \"system\",","                        \"content\": \"You are an expert network security analyst. Analyze network traffic and identify threats. Always respond with valid JSON only.\"","                    },","                    {","                        \"role\": \"user\",","                        \"content\": self._build_prompt(data)","                    }","                ],","                temperature=0.3,","                max_tokens=4096,","                response_format={\"type\": \"json_object\"}","            )","            ","            json_text = response.choices[0].message.content","            return self._parse_json_response(json_text)","            ","        except Exception as e:","            logging.error(f\"Groq error: {e}\")","            return None","    ","    def _call_openrouter(self, data, config, api_key):","        \"\"\"Call OpenRouter API (DeepSeek, Qwen, etc.)\"\"\"","        try:","            from openai import OpenAI","        except ImportError:","            logging.error(\"openai not installed. Run: pip install openai\")","            return None","        ","        try:","            client = OpenAI(","                base_url=\"https://openrouter.ai/api/v1\",","                api_key=api_key","            )","            ","            response = client.chat.completions.create(","                model=config['model'],","                messages=[","                    {","                        \"role\": \"system\",","                        \"content\": \"You are an expert network security analyst. Analyze network traffic and identify threats. Always respond with valid JSON only.\"","                    },","                    {","                        \"role\": \"user\",","                        \"content\": self._build_prompt(data)","                    }","                ],","                temperature=0.3,","                max_tokens=4096","            )","            ","            json_text = response.choices[0].message.content","            return self._parse_json_response(json_text)","            ","        except Exception as e:","            logging.error(f\"OpenRouter error: {e}\")","            return None","    ","    def _build_prompt(self, network_data):","        \"\"\"Build analysis prompt for AI\"\"\"","        ","        metrics = network_data.get('network_metrics', {})","        devices = network_data.get('devices', [])","        connections = network_data.get('connections', [])","        dns_queries = network_data.get('dns_queries', [])","        http_traffic = network_data.get('http_traffic', [])","        ","        prompt = f\"\"\"You are a network security expert analyzing home network traffic for threats.","","**Network Data Summary:**","- Total Packets: {metrics.get('total_packets', 0)}","- Total Bytes: {metrics.get('total_bytes', 0)}","- Unique Source IPs: {metrics.get('unique_src_ips', 0)}","- Unique Destination IPs: {metrics.get('unique_dst_ips', 0)}","- Protocol Distribution: {json.dumps(metrics.get('protocol_distribution', {}))}","- Active Devices: {len(devices)}","- Active Connections: {len(connections)}","- DNS Queries: {len(dns_queries)}","- HTTP Requests: {len(http_traffic)}","","**Detailed Analysis Required:**","","1. **Threat Detection:**","   - Port scans (20+ ports from same source)","   - DDoS patterns (1000+ packets/sec)","   - Botnet beacons (periodic connections)","   - Data exfiltration (large uploads to unknown IPs)","   - Brute force attempts (repeated failed connections)","","2. **Anomaly Detection:**","   - Traffic volume spikes","   - Unusual protocols","   - Off-hours activity","   - Suspicious port usage","","3. **URL/Domain Analysis:**","   - Phishing domains","   - DGA (Domain Generation Algorithm) patterns","   - Malware C&C servers","   - Typosquatting","","**Full Network Data:**","```json","{json.dumps(network_data, indent=2)}","```","","**RESPOND WITH ONLY VALID JSON IN THIS EXACT FORMAT (no markdown, no explanation):**","","{{","  \"analysis_timestamp\": \"{datetime.now().isoformat()}\",","  \"overall_threat_level\": \"LOW or MEDIUM or HIGH or CRITICAL\",","  \"network_health_score\": 0-100,","  \"threats_detected\": [","    {{","      \"threat_id\": \"THR-{datetime.now().strftime('%Y%m%d')}-001\",","      \"severity\": \"HIGH or MEDIUM or LOW\",","      \"confidence\": 0.0-1.0,","      \"threat_type\": \"Port Scan or DDoS or Malware or Botnet or Data Exfiltration\",","      \"source_ip\": \"x.x.x.x\",","      \"target_ip\": \"x.x.x.x\",","      \"description\": \"detailed explanation of the threat\",","      \"recommendation\": \"specific action to take\",","      \"indicators\": [\"list\", \"of\", \"threat\", \"indicators\"]","    }}","  ],","  \"device_anomalies\": [","    {{","      \"device_ip\": \"x.x.x.x\",","      \"device_name\": \"Device Name\",","      \"anomaly_score\": 0.0-1.0,","      \"anomaly_type\": \"Unusual Traffic Volume or Suspicious Protocol or Off-hours Activity\",","      \"baseline_deviation\": 1.0-10.0,","      \"description\": \"what is unusual about this device\"","    }}","  ],","  \"url_classifications\": [","    {{","      \"url\": \"http://example.com\",","      \"domain\": \"example.com\",","      \"risk_score\": 0.0-1.0,","      \"category\": \"Phishing or Malware or DGA or C&C or Safe\",","      \"threat_intel_match\": true or false,","      \"indicators\": [\"why this URL is risky\"],","      \"action\": \"BLOCK or WARN or ALLOW\",","      \"accessed_by\": [\"list of IPs that accessed it\"]","    }}","  ],","  \"behavior_patterns\": [","    {{","      \"pattern_type\": \"Botnet Beacon or Scanning Activity or Data Exfiltration\",","      \"confidence\": 0.0-1.0,","      \"device_ip\": \"x.x.x.x\",","      \"description\": \"description of the pattern\",","      \"characteristics\": {{","        \"interval\": 60,","        \"destination\": \"x.x.x.x\",","        \"port\": 8443","      }}","    }}","  ],","  \"dns_analysis\": [","    {{","      \"domain\": \"example.com\",","      \"classification\": \"DGA or Phishing or C&C or Safe\",","      \"risk_score\": 0.0-1.0,","      \"reason\": \"why this domain is flagged\",","      \"queried_by\": [\"list of IPs\"]","    }}","  ],","  \"alerts\": [","    {{","      \"alert_id\": \"ALT-{datetime.now().strftime('%Y%m%d')}-001\",","      \"priority\": \"CRITICAL or HIGH or MEDIUM or LOW\",","      \"title\": \"Short alert title\",","      \"message\": \"Detailed alert message for homeowner\",","      \"threat_type\": \"Port Scan or Malware or etc\",","      \"source_ip\": \"x.x.x.x\",","      \"confidence\": 0.0-1.0,","      \"indicators\": [\"list of indicators\"],","      \"recommended_action\": \"Specific action homeowner should take\",","      \"auto_block\": true or false","    }}","  ],","  \"statistics\": {{","    \"packets_analyzed\": {metrics.get('total_packets', 0)},","    \"threats_found\": 0,","    \"devices_monitored\": {len(devices)},","    \"urls_classified\": {len(dns_queries)},","    \"processing_time_ms\": 100","  }}","}}","","IMPORTANT: Return ONLY the JSON object. No markdown formatting, no explanations, just pure JSON.","\"\"\"","        ","        return prompt","    ","    def _parse_json_response(self, text):","        \"\"\"Parse JSON from AI response (handles markdown code blocks)\"\"\"","        ","        # Remove markdown code blocks if present","        text = text.strip()","        ","        # Remove ```json and ``` markers","        if text.startswith('```'):","            text = re.sub(r'^```(?:json)?\\s*\\n', '', text)","            text = re.sub(r'\\n```\\s*$', '', text)","        ","        # Try to parse JSON","        try:","            result = json.loads(text)","            return result","        except json.JSONDecodeError as e:","            logging.error(f\"Failed to parse JSON response: {e}\")","            logging.debug(f\"Response text: {text[:500]}...\")","            return None",""],"tokenizedAddedLines":[5,1000216,27,1000217,1000218,27,21,1000219,1000220,1000221,32,1000222,1000223,1000224,1000225,1000226,1000227,1000228,1000229,1000230,1000231,1000232,1000233,52,1000234,1000226,1000235,1000236,1000237,1000238,1000239,1000232,1000233,52,1000240,1000226,1000241,1000236,1000242,1000238,1000243,1000232,1000233,52,1000244,1000226,1000245,1000246,1000247,1000248,1000249,1000232,1000233,52,1000250,1000226,1000251,1000246,1000252,1000248,1000253,1000232,1000233,52,1000254,1000226,1000255,1000246,1000256,1000248,1000257,1000232,1000233,52,1000258,1000226,1000259,1000236,1000260,1000238,1000261,1000232,1000233,52,1000262,1000226,1000263,1000246,1000264,1000248,1000265,1000232,1000266,1000267,21,1000268,1000269,1000270,1000271,1000269,32,1000272,32,1000273,1000274,1000275,1000276,1000277,1000278,52,1000279,1000280,1000275,52,1000281,1000282,1000276,1000283,1000284,1000285,1000286,1000287,1000288,1000289,1000290,1000291,1000292,1000276,1000293,1000294,1000295,1000296,1000297,1000298,1000299,1000275,32,1000300,55,21,1000301,1000302,1000303,1000304,1000305,1000306,51,32,1000303,1000307,1000308,52,1000309,52,1000310,1000311,1000312,1000313,1000314,1000315,1000316,52,1000317,52,1000318,1000319,51,21,1000320,1000321,1000303,1000322,1000305,1000323,51,32,1000303,1000324,52,1000325,1000326,1000327,1000328,1000329,1000330,1000331,1000328,1000332,1000333,1000334,1000335,1000336,1000337,1000338,1000316,52,1000339,1000340,52,1000318,1000341,51,21,1000342,1000343,1000303,1000344,1000305,1000345,51,32,1000303,1000346,1000347,1000348,1000316,52,1000325,1000326,1000327,1000328,1000329,1000330,1000331,1000328,1000332,1000333,1000334,1000335,1000336,1000349,1000316,52,1000339,1000340,52,1000318,1000350,51,21,1000351,1000352,32,1000353,1000354,1000355,1000356,1000357,32,1000358,5,1000359,1000360,1000361,1000362,1000363,1000364,1000365,1000366,1000367,1000368,5,1000369,5,1000370,1000371,1000372,1000373,1000374,1000375,5,1000376,1000377,1000378,1000379,1000380,5,1000381,1000382,1000383,1000384,1000385,5,1000386,1000387,1000388,1000389,5,1000390,5,1000391,1000392,1000393,1000394,1000395,1000396,1000397,1000398,1000399,1000400,1000401,1000402,1000403,1000404,1000405,1000406,1000407,1000408,1000396,1000409,1000410,1000411,1000412,1000413,1000414,1000406,1000407,1000415,1000396,1000416,1000417,1000418,1000419,1000420,1000421,1000422,1000423,1000406,1000407,1000424,1000396,1000425,1000399,1000409,1000426,1000427,1000428,1000429,1000430,1000431,1000406,1000407,1000432,1000396,1000417,1000433,1000418,1000434,1000435,1000406,1000407,1000436,1000396,1000437,1000438,1000439,1000440,1000441,1000401,1000399,1000442,1000443,1000444,1000406,1000407,1000445,1000446,1000447,1000448,1000449,1000450,1000451,1000452,5,1000453,2,32,1000454,21,1000455,1000456,32,1000457,1000458,32,1000459,1000460,1000461,1000462,32,1000463,1000303,1000464,48,1000465,1000466,1000467,51,5]},{"originalStartLineNumberOneIndexed":33,"originalEndLineNumberExclusiveOneIndexed":77,"modifiedStartLineNumberOneIndexed":434,"modifiedEndLineNumberExclusiveOneIndexed":434},{"originalStartLineNumberOneIndexed":203,"originalEndLineNumberExclusiveOneIndexed":204,"modifiedStartLineNumberOneIndexed":560,"modifiedEndLineNumberExclusiveOneIndexed":564,"addedLines":["        ","        model_used = ai_response.get('ai_model_used', 'Unknown')","        logging.info(f\"‚úì Stored AI results from {model_used}: \"","                    f\"{len(ai_response.get('alerts', []))} alerts, \""],"tokenizedAddedLines":[32,1000468,1000469,1000470]},{"originalStartLineNumberOneIndexed":220,"originalEndLineNumberExclusiveOneIndexed":221,"modifiedStartLineNumberOneIndexed":580,"modifiedEndLineNumberExclusiveOneIndexed":581,"addedLines":["    logging.info(\"NetGuard Pro - Multi-AI Analysis Cycle\")"],"tokenizedAddedLines":[1000471]},{"originalStartLineNumberOneIndexed":229,"originalEndLineNumberExclusiveOneIndexed":229,"modifiedStartLineNumberOneIndexed":589,"modifiedEndLineNumberExclusiveOneIndexed":590,"addedLines":["        logging.info(\"Enable with: UPDATE ai_config SET value='1' WHERE key='ai_enabled';\")"],"tokenizedAddedLines":[1000472]},{"originalStartLineNumberOneIndexed":241,"originalEndLineNumberExclusiveOneIndexed":244,"modifiedStartLineNumberOneIndexed":602,"modifiedEndLineNumberExclusiveOneIndexed":608,"addedLines":["    # Create AI analyzer","    analyzer = MultiAIAnalyzer(config)","    ","    # Analyze with AI","    logging.info(\"Step 2: Analyzing with AI models...\")","    ai_response = analyzer.analyze_network_data(network_data)"],"tokenizedAddedLines":[1000473,1000474,21,1000475,1000476,1000477]},{"originalStartLineNumberOneIndexed":246,"originalEndLineNumberExclusiveOneIndexed":247,"modifiedStartLineNumberOneIndexed":610,"modifiedEndLineNumberExclusiveOneIndexed":611,"addedLines":["        logging.warning(\"No response from any AI service\")"],"tokenizedAddedLines":[1000478]},{"originalStartLineNumberOneIndexed":258,"originalEndLineNumberExclusiveOneIndexed":259,"modifiedStartLineNumberOneIndexed":622,"modifiedEndLineNumberExclusiveOneIndexed":623,"addedLines":["            'All AI services unavailable or no API keys configured'"],"tokenizedAddedLines":[1000479]},{"originalStartLineNumberOneIndexed":271,"originalEndLineNumberExclusiveOneIndexed":271,"modifiedStartLineNumberOneIndexed":635,"modifiedEndLineNumberExclusiveOneIndexed":636,"addedLines":["        logging.info(f\"   Model Used: {ai_response.get('ai_model_used', 'Unknown')}\")"],"tokenizedAddedLines":[1000480]},{"originalStartLineNumberOneIndexed":285,"originalEndLineNumberExclusiveOneIndexed":289,"modifiedStartLineNumberOneIndexed":650,"modifiedEndLineNumberExclusiveOneIndexed":653,"addedLines":["        logging.info(\"\\n‚ÑπÔ∏è  Note: Configure API keys for AI analysis\")","        logging.info(\"   See: /home/jarvis/NetGuard/API_KEY_SETUP.md\")","        logging.info(\"   Or run: python3 /home/jarvis/NetGuard/scripts/setup_api_keys.py\")"],"tokenizedAddedLines":[1000481,1000482,1000483]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}