{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\iftop_collector.py","fileUuid":"7f08f63f-5a2f-4baa-a5ab-1af88f3fb494","fileSizeBytes":7589,"numLines":245,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":246,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - iftop Collector","Real-time bandwidth monitoring per connection","\"\"\"","","import os","import subprocess","import sqlite3","import logging","import time","import re","from datetime import datetime","","# Configuration","INTERFACE = \"eno1\"","CAPTURE_DIR = \"/home/jarvis/NetGuard/captures/iftop\"","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/iftop-collector.log\"","COLLECT_INTERVAL = 30  # Collect every 30 seconds","","# Setup logging","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","def create_table(conn, table_name):","    \"\"\"Create iftop table if it doesn't exist\"\"\"","    cursor = conn.cursor()","    sql = f\"\"\"","    CREATE TABLE IF NOT EXISTS {table_name} (","        id INTEGER PRIMARY KEY AUTOINCREMENT,","        timestamp TEXT NOT NULL,","        src_ip TEXT,","        src_port INTEGER,","        dest_ip TEXT,","        dest_port INTEGER,","        tx_rate TEXT,","        rx_rate TEXT,","        total_rate TEXT,","        created_at DATETIME DEFAULT CURRENT_TIMESTAMP","    );","    \"\"\"","    cursor.execute(sql)","    conn.commit()","","def parse_iftop_output(output):","    \"\"\"Parse iftop text output\"\"\"","    try:","        entries = []","        lines = output.split('\\n')","        ","        for line in lines:","            line = line.strip()","            if not line or '=>' not in line:","                continue","            ","            # iftop output format (example):","            # 192.168.1.100:12345 => 8.8.8.8:53  1.23Kb  2.45Kb  3.67Kb","            # 192.168.1.100       <= 8.8.8.8     4.56Kb  5.67Kb  6.78Kb","            ","            try:","                # Split by => or <=","                if '=>' in line:","                    parts = line.split('=>')","                    direction = 'TX'","                elif '<=' in line:","                    parts = line.split('<=')","                    direction = 'RX'","                else:","                    continue","                ","                if len(parts) < 2:","                    continue","                ","                # Parse source","                src = parts[0].strip()","                src_ip = ''","                src_port = None","                if ':' in src:","                    src_parts = src.split(':')","                    src_ip = src_parts[0]","                    try:","                        src_port = int(src_parts[1])","                    except:","                        pass","                else:","                    src_ip = src","                ","                # Parse destination and rates","                dest_and_rates = parts[1].strip().split()","                if len(dest_and_rates) < 1:","                    continue","                ","                dest = dest_and_rates[0]","                dest_ip = ''","                dest_port = None","                if ':' in dest:","                    dest_parts = dest.split(':')","                    dest_ip = dest_parts[0]","                    try:","                        dest_port = int(dest_parts[1])","                    except:","                        pass","                else:","                    dest_ip = dest","                ","                # Parse rates (last 2 seconds, 10 seconds, 40 seconds averages)","                rates = [r for r in dest_and_rates[1:] if any(c in r for c in ['K', 'M', 'G', 'b'])]","                ","                tx_rate = rates[0] if len(rates) > 0 else ''","                rx_rate = rates[1] if len(rates) > 1 else ''","                total_rate = rates[2] if len(rates) > 2 else ''","                ","                entry = {","                    'timestamp': datetime.now().isoformat(),","                    'src_ip': src_ip,","                    'src_port': src_port,","                    'dest_ip': dest_ip,","                    'dest_port': dest_port,","                    'tx_rate': tx_rate,","                    'rx_rate': rx_rate,","                    'total_rate': total_rate","                }","                ","                if src_ip and dest_ip:","                    entries.append(entry)","                    ","            except Exception as e:","                logging.debug(f\"Error parsing line: {e}\")","                continue","        ","        return entries","        ","    except Exception as e:","        logging.error(f\"Error parsing iftop output: {e}\")","        return []","","def collect_iftop_data():","    \"\"\"Collect bandwidth data using iftop\"\"\"","    try:","        logging.info(\"Collecting iftop data...\")","        ","        # Run iftop in text mode for 10 seconds","        # -i: interface","        # -t: text output","        # -s: duration","        # -n: no DNS resolution","        # -P: show ports","        cmd = [","            'sudo', 'iftop',","            '-i', INTERFACE,","            '-t',","            '-s', '10',","            '-n',","            '-P'","        ]","        ","        result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)","        ","        if result.returncode != 0 or not result.stdout:","            logging.warning(\"No iftop data captured\")","            return","        ","        # Parse output","        entries = parse_iftop_output(result.stdout)","        ","        if not entries:","            logging.debug(\"No entries parsed from iftop\")","            return","        ","        # Create table","        timestamp_str = datetime.now().strftime('%Y%m%d_%H%M%S')","        table_name = f\"iftop_{timestamp_str}\"","        ","        conn = sqlite3.connect(DB_PATH)","        create_table(conn, table_name)","        cursor = conn.cursor()","        ","        # Insert entries","        inserted = 0","        for entry in entries:","            try:","                cursor.execute(f\"\"\"","                    INSERT INTO {table_name}","                    (timestamp, src_ip, src_port, dest_ip, dest_port, tx_rate, rx_rate, total_rate)","                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)","                \"\"\", (","                    entry.get('timestamp'),","                    entry.get('src_ip', ''),","                    entry.get('src_port'),","                    entry.get('dest_ip', ''),","                    entry.get('dest_port'),","                    entry.get('tx_rate', ''),","                    entry.get('rx_rate', ''),","                    entry.get('total_rate', '')","                ))","                inserted += 1","            except Exception as e:","                logging.debug(f\"Error inserting entry: {e}\")","                continue","        ","        conn.commit()","        conn.close()","        ","        if inserted > 0:","            logging.info(f\"âœ“ Inserted {inserted} bandwidth records into '{table_name}'\")","        ","    except subprocess.TimeoutExpired:","        logging.error(\"iftop collection timeout\")","    except Exception as e:","        logging.error(f\"Error collecting iftop data: {e}\")","","def main():","    \"\"\"Main collection loop\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - iftop Collector\")","    logging.info(\"=\" * 60)","    logging.info(f\"Interface: {INTERFACE}\")","    logging.info(f\"Collection interval: {COLLECT_INTERVAL} seconds\")","    logging.info(\"=\" * 60)","    ","    os.makedirs(CAPTURE_DIR, exist_ok=True)","    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)","    ","    while True:","        try:","            collect_iftop_data()","            time.sleep(COLLECT_INTERVAL)","        except KeyboardInterrupt:","            logging.info(\"Shutting down iftop collector...\")","            break","        except Exception as e:","            logging.error(f\"Error in main loop: {e}\")","            time.sleep(COLLECT_INTERVAL)","","if __name__ == \"__main__\":","    main()","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000004,1000012,1000013,1000014,1000015,1000016,1000017,1000004,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000004,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000004,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000056,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000069,1000070,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000068,1000083,1000070,1000084,1000085,1000086,1000069,1000070,1000087,1000088,1000089,1000090,1000091,1000092,1000079,1000093,1000081,1000082,1000068,1000094,1000070,1000095,1000096,1000070,1000097,1000098,1000099,1000070,1000100,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000108,1000109,1000070,1000110,1000111,1000112,1000113,1000114,1000055,1000051,1000115,1000051,1000116,1000117,1000118,1000004,1000119,1000120,1000048,1000121,1000051,1000122,1000123,1000124,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000133,1000134,1000135,1000051,1000136,1000051,1000137,1000138,1000139,1000051,1000140,1000141,1000051,1000142,1000143,1000139,1000051,1000144,1000145,1000146,1000051,1000147,1000148,1000149,1000051,1000150,1000151,1000152,1000060,1000153,1000154,1000155,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000163,1000164,1000165,1000166,1000167,1000113,1000168,1000055,1000051,1000169,1000170,1000051,1000171,1000172,1000051,1000173,1000174,1000116,1000175,1000004,1000176,1000177,1000178,1000179,1000178,1000180,1000181,1000178,1000182,1000183,1000184,1000182,1000185,1000186,1000187,1000188,1000189,1000190,1000191,1000192,1000193,1000188,1000004,1000194,1000195,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}