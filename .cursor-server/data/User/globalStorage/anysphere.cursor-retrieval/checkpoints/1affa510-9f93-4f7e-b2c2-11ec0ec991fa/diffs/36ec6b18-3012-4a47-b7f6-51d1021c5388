{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\netsniff_collector.py","fileUuid":"36ec6b18-3012-4a47-b7f6-51d1021c5388","fileSizeBytes":10169,"numLines":303,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":304,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - netsniff-ng Collector","High-performance packet capture using netsniff-ng","\"\"\"","","import os","import subprocess","import sqlite3","import logging","import time","import json","from datetime import datetime","from pathlib import Path","","# Configuration","INTERFACE = \"wlx1cbfce6265ad\"","CAPTURE_DIR = \"/home/jarvis/NetGuard/captures/netsniff\"","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/netsniff-collector.log\"","COLLECT_INTERVAL = 30  # Process files every 30 seconds","PROCESSED_FILES = \"/home/jarvis/NetGuard/logs/system/processed_netsniff.txt\"","","# Setup logging","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","# netsniff-ng process handle","netsniff_process = None","","def load_processed_files():","    \"\"\"Load list of already processed files\"\"\"","    if os.path.exists(PROCESSED_FILES):","        with open(PROCESSED_FILES, 'r') as f:","            return set(line.strip() for line in f)","    return set()","","def mark_as_processed(filename):","    \"\"\"Mark a file as processed\"\"\"","    with open(PROCESSED_FILES, 'a') as f:","        f.write(f\"{filename}\\n\")","","def create_table(conn, table_name):","    \"\"\"Create netsniff table if it doesn't exist\"\"\"","    cursor = conn.cursor()","    sql = f\"\"\"","    CREATE TABLE IF NOT EXISTS {table_name} (","        id INTEGER PRIMARY KEY AUTOINCREMENT,","        timestamp TEXT NOT NULL,","        src_ip TEXT,","        src_port INTEGER,","        dest_ip TEXT,","        dest_port INTEGER,","        protocol TEXT,","        packet_length INTEGER,","        created_at DATETIME DEFAULT CURRENT_TIMESTAMP","    );","    \"\"\"","    cursor.execute(sql)","    conn.commit()","","def start_netsniff():","    \"\"\"Start netsniff-ng process\"\"\"","    global netsniff_process","    ","    try:","        logging.info(f\"Starting netsniff-ng on {INTERFACE}...\")","        ","        # Start netsniff-ng","        # -i: input interface","        # --in: packet type (eth for Ethernet)","        # -o: output directory","        # -s: silent mode","        # -b: CPU affinity (bind to specific CPUs)","        # Note: netsniff-ng creates files automatically with timestamps","        ","        # Create output prefix","        output_prefix = os.path.join(CAPTURE_DIR, \"capture\")","        ","        # Note: netsniff-ng doesn't support --interval in all versions","        # We'll use a simpler approach and manually rotate","        netsniff_process = subprocess.Popen([","            'sudo', 'netsniff-ng',","            '--in', INTERFACE,","            '--out', CAPTURE_DIR,","            '--prefix', 'capture_',","            '--type', 'pcap',","            '--silent',","            '--bind-cpu', '0,1',","            '--ring-size', '8192'","        ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)","        ","        time.sleep(2)  # Give it time to start","        ","        if netsniff_process.poll() is None:","            logging.info(\"✓ netsniff-ng started successfully\")","            return True","        else:","            stderr_output = netsniff_process.stderr.read().decode('utf-8', errors='ignore')","            logging.error(f\"✗ netsniff-ng failed to start: {stderr_output}\")","            ","            # Try alternative command without CPU binding","            logging.info(\"Trying netsniff-ng without CPU binding...\")","            netsniff_process = subprocess.Popen([","                'sudo', 'netsniff-ng',","                '--in', INTERFACE,","                '--out', output_prefix,","                '--type', 'pcap',","                '--silent'","            ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)","            ","            time.sleep(2)","            ","            if netsniff_process.poll() is None:","                logging.info(\"✓ netsniff-ng started successfully (without CPU binding)\")","                return True","            else:","                logging.error(\"✗ netsniff-ng failed to start\")","                return False","            ","    except Exception as e:","        logging.error(f\"Error starting netsniff-ng: {e}\")","        return False","","def process_pcap_file(pcap_file):","    \"\"\"Process PCAP file and insert into database\"\"\"","    try:","        basename = os.path.basename(pcap_file)","        logging.info(f\"Processing {basename}...\")","        ","        # Use tshark to read PCAP","        cmd = [","            'tshark', '-r', pcap_file,","            '-T', 'json',","            '-e', 'frame.time',","            '-e', 'frame.len',","            '-e', 'ip.src',","            '-e', 'ip.dst',","            '-e', 'tcp.srcport',","            '-e', 'tcp.dstport',","            '-e', 'udp.srcport',","            '-e', 'udp.dstport',","            '-e', 'frame.protocols'","        ]","        ","        result = subprocess.run(cmd, capture_output=True, text=True, timeout=120)","        ","        if result.returncode != 0 or not result.stdout:","            logging.warning(f\"No data in {basename}\")","            return True  # Still mark as processed","        ","        # Parse JSON","        packets = json.loads(result.stdout)","        ","        if not packets:","            logging.warning(f\"No packets parsed from {basename}\")","            return True","        ","        # Create table","        timestamp_str = datetime.now().strftime('%Y%m%d_%H%M%S')","        table_name = f\"netsniff_{timestamp_str}\"","        ","        conn = sqlite3.connect(DB_PATH)","        create_table(conn, table_name)","        cursor = conn.cursor()","        ","        # Insert packets","        inserted = 0","        for packet in packets:","            try:","                layers = packet.get('_source', {}).get('layers', {})","                ","                timestamp = layers.get('frame.time', [''])[0]","                length = layers.get('frame.len', [''])[0]","                src_ip = layers.get('ip.src', [''])[0]","                dest_ip = layers.get('ip.dst', [''])[0]","                protocols = layers.get('frame.protocols', [''])[0]","                ","                # Get ports","                src_port = layers.get('tcp.srcport', layers.get('udp.srcport', ['']))[0]","                dest_port = layers.get('tcp.dstport', layers.get('udp.dstport', ['']))[0]","                ","                # Convert to int","                try:","                    src_port = int(src_port) if src_port else None","                    dest_port = int(dest_port) if dest_port else None","                    length = int(length) if length else None","                except:","                    pass","                ","                # Determine protocol","                if 'tcp' in protocols.lower():","                    protocol = 'TCP'","                elif 'udp' in protocols.lower():","                    protocol = 'UDP'","                elif 'icmp' in protocols.lower():","                    protocol = 'ICMP'","                else:","                    protocol = protocols.split(':')[-1] if protocols else 'Unknown'","                ","                cursor.execute(f\"\"\"","                    INSERT INTO {table_name}","                    (timestamp, src_ip, src_port, dest_ip, dest_port, protocol, packet_length)","                    VALUES (?, ?, ?, ?, ?, ?, ?)","                \"\"\", (timestamp, src_ip, src_port, dest_ip, dest_port, protocol, length))","                ","                inserted += 1","            except Exception as e:","                logging.debug(f\"Error inserting packet: {e}\")","                continue","        ","        conn.commit()","        conn.close()","        ","        logging.info(f\"✓ Inserted {inserted} packets from {basename} into '{table_name}'\")","        return True","        ","    except subprocess.TimeoutExpired:","        logging.error(f\"Timeout processing {pcap_file}\")","        return False","    except Exception as e:","        logging.error(f\"Error processing {pcap_file}: {e}\")","        return False","","def collect_netsniff_data():","    \"\"\"Collect and process netsniff-ng PCAP files\"\"\"","    try:","        processed = load_processed_files()","        ","        # Find PCAP files","        pcap_files = sorted(Path(CAPTURE_DIR).glob('capture_*.pcap'))","        ","        for pcap_file in pcap_files:","            pcap_path = str(pcap_file)","            ","            # Skip if already processed","            if pcap_path in processed:","                continue","            ","            # Check if file is old enough (not being written)","            file_age = time.time() - os.path.getmtime(pcap_path)","            if file_age < 30:","                logging.debug(f\"Skipping {pcap_file.name} (still being written)\")","                continue","            ","            # Process file","            success = process_pcap_file(pcap_path)","            ","            if success:","                processed.add(pcap_path)","                mark_as_processed(pcap_path)","                ","                # Delete processed file to save space","                try:","                    os.remove(pcap_path)","                    logging.debug(f\"Deleted processed file: {pcap_file.name}\")","                except:","                    pass","        ","    except Exception as e:","        logging.error(f\"Error collecting netsniff data: {e}\")","","def main():","    \"\"\"Main collection loop\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - netsniff-ng Collector\")","    logging.info(\"=\" * 60)","    logging.info(f\"Interface: {INTERFACE}\")","    logging.info(f\"Collection interval: {COLLECT_INTERVAL} seconds\")","    logging.info(\"=\" * 60)","    ","    os.makedirs(CAPTURE_DIR, exist_ok=True)","    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)","    ","    # Start netsniff-ng","    if not start_netsniff():","        logging.warning(\"Failed to start netsniff-ng. Will still process existing files.\")","        # Don't exit - we can still process existing files","    ","    try:","        while True:","            collect_netsniff_data()","            time.sleep(COLLECT_INTERVAL)","    except KeyboardInterrupt:","        logging.info(\"Shutting down netsniff-ng collector...\")","        if netsniff_process:","            netsniff_process.terminate()","            netsniff_process.wait()","    except Exception as e:","        logging.error(f\"Error in main loop: {e}\")","        if netsniff_process:","            netsniff_process.terminate()","","if __name__ == \"__main__\":","    main()","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000004,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000004,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000004,1000029,1000030,1000004,1000031,1000032,1000033,1000034,1000035,1000036,1000004,1000037,1000038,1000039,1000040,1000004,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000004,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000065,1000073,1000074,1000065,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000085,1000086,1000065,1000087,1000065,1000088,1000089,1000090,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000102,1000103,1000094,1000104,1000094,1000105,1000106,1000107,1000108,1000109,1000110,1000094,1000111,1000112,1000113,1000004,1000114,1000115,1000063,1000116,1000117,1000065,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000065,1000132,1000065,1000133,1000134,1000135,1000065,1000136,1000137,1000065,1000138,1000139,1000090,1000065,1000140,1000141,1000142,1000065,1000143,1000144,1000145,1000065,1000146,1000147,1000148,1000149,1000150,1000151,1000152,1000153,1000154,1000155,1000156,1000151,1000157,1000158,1000159,1000151,1000160,1000161,1000162,1000163,1000164,1000165,1000166,1000151,1000167,1000168,1000169,1000170,1000171,1000172,1000173,1000174,1000175,1000151,1000176,1000177,1000178,1000179,1000180,1000151,1000181,1000182,1000183,1000184,1000065,1000185,1000186,1000065,1000187,1000188,1000065,1000189,1000190,1000113,1000111,1000191,1000113,1000004,1000192,1000193,1000063,1000194,1000065,1000195,1000196,1000065,1000197,1000198,1000094,1000199,1000200,1000184,1000094,1000201,1000202,1000203,1000204,1000184,1000094,1000205,1000206,1000094,1000207,1000208,1000209,1000151,1000210,1000161,1000211,1000212,1000165,1000166,1000065,1000111,1000213,1000004,1000214,1000215,1000216,1000217,1000216,1000218,1000219,1000216,1000062,1000220,1000221,1000062,1000222,1000223,1000224,1000225,1000062,1000063,1000226,1000227,1000228,1000229,1000230,1000231,1000232,1000233,1000111,1000234,1000231,1000232,1000004,1000235,1000236,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}