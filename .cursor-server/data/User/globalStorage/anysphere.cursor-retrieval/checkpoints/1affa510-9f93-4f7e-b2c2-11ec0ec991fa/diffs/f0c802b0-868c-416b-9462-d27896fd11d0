{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\argus_collector.py","fileUuid":"f0c802b0-868c-416b-9462-d27896fd11d0","fileSizeBytes":10315,"numLines":334,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":335,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - argus Collector","Network flow analysis using argus","\"\"\"","","import os","import subprocess","import sqlite3","import logging","import time","import re","from datetime import datetime","","# Configuration","INTERFACE = \"wlo1\"","CAPTURE_DIR = \"/home/jarvis/NetGuard/captures/argus\"","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/argus-collector.log\"","ARGUS_FILE = os.path.join(CAPTURE_DIR, \"argus.out\")","COLLECT_INTERVAL = 30  # Collect data every 30 seconds","","# Setup logging","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","# argus process handle","argus_process = None","","def create_table(conn, table_name):","    \"\"\"Create argus table if it doesn't exist\"\"\"","    cursor = conn.cursor()","    sql = f\"\"\"","    CREATE TABLE IF NOT EXISTS {table_name} (","        id INTEGER PRIMARY KEY AUTOINCREMENT,","        timestamp TEXT NOT NULL,","        start_time TEXT,","        last_time TEXT,","        duration REAL,","        src_ip TEXT,","        src_port INTEGER,","        dest_ip TEXT,","        dest_port INTEGER,","        proto TEXT,","        src_packets INTEGER,","        dest_packets INTEGER,","        src_bytes INTEGER,","        dest_bytes INTEGER,","        state TEXT,","        created_at DATETIME DEFAULT CURRENT_TIMESTAMP","    );","    \"\"\"","    cursor.execute(sql)","    conn.commit()","","def start_argus():","    \"\"\"Start argus process\"\"\"","    global argus_process","    ","    try:","        # Clear old output","        if os.path.exists(ARGUS_FILE):","            os.remove(ARGUS_FILE)","        ","        logging.info(f\"Starting argus on {INTERFACE}...\")","        ","        # Start argus","        # -i: interface","        # -B: buffer size","        # -S: status interval","        # -w: output file","        argus_process = subprocess.Popen([","            'sudo', 'argus',","            '-i', INTERFACE,","            '-B', '8m',","            '-S', '60',","            '-w', ARGUS_FILE","        ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)","        ","        time.sleep(2)  # Give it time to start","        ","        if argus_process.poll() is None:","            logging.info(\"✓ argus started successfully\")","            return True","        else:","            stderr_output = argus_process.stderr.read().decode('utf-8', errors='ignore')","            logging.error(f\"✗ argus failed to start: {stderr_output}\")","            return False","            ","    except Exception as e:","        logging.error(f\"Error starting argus: {e}\")","        return False","","def parse_ra_line(line):","    \"\"\"Parse ra output line (argus client)\"\"\"","    try:","        # ra output format (columns):","        # StartTime Flgs Proto SrcAddr Sport Dir DstAddr Dport TotPkts TotBytes State","        parts = line.split()","        ","        if len(parts) < 10:","            return None","        ","        data = {}","        ","        # Parse timestamp (first two columns are date and time)","        try:","            data['start_time'] = f\"{parts[0]} {parts[1]}\"","        except:","            data['start_time'] = ''","        ","        idx = 2","        ","        # Duration","        try:","            if parts[idx].replace('.', '').isdigit():","                data['duration'] = float(parts[idx])","                idx += 1","            else:","                data['duration'] = 0","        except:","            data['duration'] = 0","        ","        # Protocol","        try:","            proto = parts[idx]","            if proto in ['tcp', 'udp', 'icmp', 'arp']:","                data['proto'] = proto.upper()","                idx += 1","            else:","                data['proto'] = 'OTHER'","        except:","            data['proto'] = 'UNKNOWN'","        ","        # Source IP:Port","        try:","            src_parts = parts[idx].split(':')","            data['src_ip'] = src_parts[0] if len(src_parts) > 0 else ''","            data['src_port'] = int(src_parts[1]) if len(src_parts) > 1 and src_parts[1].isdigit() else None","            idx += 1","        except:","            data['src_ip'] = ''","            data['src_port'] = None","        ","        # Direction (skip)","        idx += 1","        ","        # Destination IP:Port","        try:","            dst_parts = parts[idx].split(':')","            data['dest_ip'] = dst_parts[0] if len(dst_parts) > 0 else ''","            data['dest_port'] = int(dst_parts[1]) if len(dst_parts) > 1 and dst_parts[1].isdigit() else None","            idx += 1","        except:","            data['dest_ip'] = ''","            data['dest_port'] = None","        ","        # Packets (may be SrcPkts:DstPkts)","        try:","            if ':' in parts[idx]:","                pkts = parts[idx].split(':')","                data['src_packets'] = int(pkts[0]) if pkts[0].isdigit() else 0","                data['dest_packets'] = int(pkts[1]) if len(pkts) > 1 and pkts[1].isdigit() else 0","            else:","                data['src_packets'] = int(parts[idx]) if parts[idx].isdigit() else 0","                data['dest_packets'] = 0","            idx += 1","        except:","            data['src_packets'] = 0","            data['dest_packets'] = 0","        ","        # Bytes (may be SrcBytes:DstBytes)","        try:","            if ':' in parts[idx]:","                bytes_data = parts[idx].split(':')","                data['src_bytes'] = int(bytes_data[0]) if bytes_data[0].isdigit() else 0","                data['dest_bytes'] = int(bytes_data[1]) if len(bytes_data) > 1 and bytes_data[1].isdigit() else 0","            else:","                data['src_bytes'] = int(parts[idx]) if parts[idx].isdigit() else 0","                data['dest_bytes'] = 0","            idx += 1","        except:","            data['src_bytes'] = 0","            data['dest_bytes'] = 0","        ","        # State (remaining columns)","        try:","            data['state'] = ' '.join(parts[idx:]) if idx < len(parts) else ''","        except:","            data['state'] = ''","        ","        return data","        ","    except Exception as e:","        logging.debug(f\"Error parsing ra line: {e}\")","        return None","","def collect_argus_data():","    \"\"\"Collect data from argus using ra client\"\"\"","    try:","        if not os.path.exists(ARGUS_FILE):","            return","        ","        # Use ra (argus client) to read argus data","        # -r: read from file","        # -n: no DNS resolution","        cmd = ['ra', '-r', ARGUS_FILE, '-n']","        ","        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)","        ","        if result.returncode != 0 or not result.stdout:","            return","        ","        lines = result.stdout.strip().split('\\n')","        ","        # Skip header lines","        data_lines = [line for line in lines if not line.startswith('StartTime') and line.strip()]","        ","        if not data_lines:","            return","        ","        # Parse flows","        flows = []","        for line in data_lines:","            parsed = parse_ra_line(line)","            if parsed:","                parsed['timestamp'] = datetime.now().isoformat()","                flows.append(parsed)","        ","        if not flows:","            return","        ","        # Create table","        timestamp_str = datetime.now().strftime('%Y%m%d_%H%M%S')","        table_name = f\"argus_{timestamp_str}\"","        ","        conn = sqlite3.connect(DB_PATH)","        create_table(conn, table_name)","        cursor = conn.cursor()","        ","        # Insert flows","        inserted = 0","        for flow in flows:","            try:","                cursor.execute(f\"\"\"","                    INSERT INTO {table_name}","                    (timestamp, start_time, last_time, duration, src_ip, src_port, dest_ip, dest_port,","                     proto, src_packets, dest_packets, src_bytes, dest_bytes, state)","                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)","                \"\"\", (","                    flow.get('timestamp'),","                    flow.get('start_time', ''),","                    flow.get('last_time', ''),","                    flow.get('duration', 0),","                    flow.get('src_ip', ''),","                    flow.get('src_port'),","                    flow.get('dest_ip', ''),","                    flow.get('dest_port'),","                    flow.get('proto', ''),","                    flow.get('src_packets', 0),","                    flow.get('dest_packets', 0),","                    flow.get('src_bytes', 0),","                    flow.get('dest_bytes', 0),","                    flow.get('state', '')","                ))","                inserted += 1","            except Exception as e:","                logging.debug(f\"Error inserting flow: {e}\")","                continue","        ","        conn.commit()","        conn.close()","        ","        if inserted > 0:","            logging.info(f\"✓ Inserted {inserted} flows into '{table_name}'\")","        ","        # Clear argus file for next collection","        try:","            os.remove(ARGUS_FILE)","            # Restart argus to create new file","            if argus_process and argus_process.poll() is None:","                argus_process.terminate()","                argus_process.wait()","                time.sleep(1)","                start_argus()","        except:","            pass","            ","    except subprocess.TimeoutExpired:","        logging.error(\"Timeout reading argus data\")","    except Exception as e:","        logging.error(f\"Error collecting argus data: {e}\")","","def main():","    \"\"\"Main collection loop\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - argus Collector\")","    logging.info(\"=\" * 60)","    logging.info(f\"Interface: {INTERFACE}\")","    logging.info(f\"Collection interval: {COLLECT_INTERVAL} seconds\")","    logging.info(\"=\" * 60)","    ","    os.makedirs(CAPTURE_DIR, exist_ok=True)","    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)","    ","    # Start argus","    if not start_argus():","        logging.error(\"Failed to start argus. Exiting.\")","        return","    ","    try:","        while True:","            time.sleep(COLLECT_INTERVAL)","            collect_argus_data()","    except KeyboardInterrupt:","        logging.info(\"Shutting down argus collector...\")","        if argus_process:","            argus_process.terminate()","            argus_process.wait()","    except Exception as e:","        logging.error(f\"Error in main loop: {e}\")","        if argus_process:","            argus_process.terminate()","","if __name__ == \"__main__\":","    main()","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000004,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000004,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000004,1000028,1000029,1000004,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000004,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000063,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000063,1000077,1000063,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000085,1000086,1000087,1000088,1000004,1000089,1000090,1000059,1000091,1000092,1000093,1000063,1000094,1000095,1000063,1000096,1000063,1000097,1000098,1000099,1000100,1000101,1000063,1000102,1000063,1000103,1000098,1000104,1000105,1000106,1000107,1000108,1000100,1000109,1000063,1000110,1000098,1000111,1000112,1000113,1000106,1000107,1000114,1000100,1000115,1000063,1000116,1000098,1000117,1000118,1000119,1000120,1000100,1000121,1000122,1000063,1000123,1000124,1000063,1000125,1000098,1000126,1000127,1000128,1000120,1000100,1000129,1000130,1000063,1000131,1000098,1000132,1000133,1000134,1000135,1000107,1000136,1000137,1000120,1000100,1000138,1000139,1000063,1000140,1000098,1000132,1000141,1000142,1000143,1000107,1000144,1000145,1000120,1000100,1000146,1000147,1000063,1000148,1000098,1000149,1000100,1000150,1000063,1000151,1000063,1000086,1000152,1000153,1000004,1000154,1000155,1000059,1000156,1000157,1000063,1000158,1000159,1000160,1000161,1000063,1000162,1000063,1000163,1000157,1000063,1000164,1000063,1000165,1000166,1000063,1000167,1000157,1000063,1000168,1000169,1000170,1000171,1000172,1000173,1000174,1000063,1000175,1000157,1000063,1000176,1000177,1000178,1000063,1000179,1000180,1000181,1000063,1000182,1000183,1000184,1000185,1000186,1000187,1000188,1000189,1000190,1000191,1000192,1000193,1000194,1000195,1000196,1000197,1000198,1000199,1000200,1000201,1000202,1000203,1000204,1000205,1000206,1000207,1000208,1000209,1000210,1000063,1000211,1000212,1000063,1000213,1000214,1000063,1000215,1000098,1000062,1000216,1000217,1000218,1000219,1000220,1000221,1000100,1000222,1000085,1000223,1000224,1000086,1000225,1000004,1000226,1000227,1000228,1000229,1000228,1000230,1000231,1000228,1000058,1000232,1000233,1000058,1000234,1000235,1000236,1000237,1000058,1000059,1000238,1000239,1000240,1000241,1000242,1000243,1000244,1000245,1000086,1000246,1000243,1000244,1000004,1000247,1000248,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}