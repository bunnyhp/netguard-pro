{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\json_to_sqlite.py","fileUuid":"134cb2eb-992a-4a8c-83e8-9bea530d5946","fileSizeBytes":6002,"numLines":186,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":187,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - JSON to SQLite Converter","Monitors JSON directory and inserts data into SQLite database with timestamped tables","\"\"\"","","import os","import json","import time","import sqlite3","import logging","from datetime import datetime","from pathlib import Path","","# Configuration","JSON_DIR = \"/home/jarvis/NetGuard/captures/processed_json\"","DB_PATH = \"/home/jarvis/NetGuard/network.db\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/json-to-sqlite.log\"","PROCESSED_FILES = \"/home/jarvis/NetGuard/logs/system/processed_jsons.txt\"","CHECK_INTERVAL = 10  # seconds","","# Setup logging","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","def load_processed_files():","    \"\"\"Load list of already processed JSON files\"\"\"","    if os.path.exists(PROCESSED_FILES):","        with open(PROCESSED_FILES, 'r') as f:","            return set(line.strip() for line in f)","    return set()","","def mark_as_processed(filename):","    \"\"\"Mark a file as processed\"\"\"","    with open(PROCESSED_FILES, 'a') as f:","        f.write(f\"{filename}\\n\")","","def create_network_table(conn, table_name):","    \"\"\"Create a timestamped network table if it doesn't exist\"\"\"","    cursor = conn.cursor()","    ","    create_sql = f\"\"\"","    CREATE TABLE IF NOT EXISTS {table_name} (","        id INTEGER PRIMARY KEY AUTOINCREMENT,","        timestamp TEXT NOT NULL,","        source_ip TEXT,","        source_port INTEGER,","        destination_ip TEXT,","        destination_port INTEGER,","        protocol TEXT,","        packet_length INTEGER,","        flags TEXT,","        ttl INTEGER,","        raw_data TEXT,","        created_at DATETIME DEFAULT CURRENT_TIMESTAMP","    );","    \"\"\"","    ","    cursor.execute(create_sql)","    conn.commit()","","def insert_json_to_database(json_file):","    \"\"\"Insert JSON data into SQLite database\"\"\"","    try:","        # Extract timestamp from filename (network_YYYYMMDD_HHMMSS.json)","        basename = os.path.basename(json_file)","        timestamp_str = basename.replace('network_', '').replace('.json', '')","        table_name = f\"network_{timestamp_str}\"","        ","        logging.info(f\"Processing {basename}...\")","        ","        # Read JSON file","        with open(json_file, 'r') as f:","            packets = json.load(f)","        ","        if not packets:","            logging.warning(f\"No packets in {basename}\")","            return True","        ","        # Connect to database","        conn = sqlite3.connect(DB_PATH)","        ","        # Create table","        create_network_table(conn, table_name)","        ","        # Insert packets","        cursor = conn.cursor()","        inserted_count = 0","        ","        for packet in packets:","            try:","                cursor.execute(f\"\"\"","                    INSERT INTO {table_name} ","                    (timestamp, source_ip, source_port, destination_ip, destination_port, ","                     protocol, packet_length, flags, ttl, raw_data)","                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)","                \"\"\", (","                    packet.get('timestamp', ''),","                    packet.get('source_ip', ''),","                    packet.get('source_port'),","                    packet.get('destination_ip', ''),","                    packet.get('destination_port'),","                    packet.get('protocol', ''),","                    packet.get('packet_length'),","                    packet.get('flags', ''),","                    packet.get('ttl'),","                    json.dumps(packet)  # Store full packet as JSON","                ))","                inserted_count += 1","            except Exception as e:","                logging.debug(f\"Error inserting packet: {e}\")","                continue","        ","        conn.commit()","        conn.close()","        ","        logging.info(f\"✓ Inserted {inserted_count} packets into table '{table_name}'\")","        return True","        ","    except Exception as e:","        logging.error(f\"✗ Error processing {json_file}: {e}\")","        return False","","def monitor_and_insert():","    \"\"\"Monitor JSON directory and insert data into database\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - JSON to SQLite Converter\")","    logging.info(\"=\" * 60)","    logging.info(f\"Monitoring directory: {JSON_DIR}\")","    logging.info(f\"Database: {DB_PATH}\")","    logging.info(f\"Check interval: {CHECK_INTERVAL} seconds\")","    logging.info(\"=\" * 60)","    ","    # Create directories if they don't exist","    os.makedirs(JSON_DIR, exist_ok=True)","    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)","    ","    # Load processed files","    processed = load_processed_files()","    ","    while True:","        try:","            # Get all JSON files","            json_files = sorted(Path(JSON_DIR).glob('network_*.json'))","            ","            for json_file in json_files:","                json_path = str(json_file)","                ","                # Skip if already processed","                if json_path in processed:","                    continue","                ","                # Check if file is complete (older than 5 seconds)","                file_age = time.time() - os.path.getmtime(json_path)","                if file_age < 5:","                    logging.debug(f\"Skipping {json_file.name} (still being written)\")","                    continue","                ","                # Insert to database","                success = insert_json_to_database(json_path)","                ","                if success:","                    # Mark as processed","                    processed.add(json_path)","                    mark_as_processed(json_path)","            ","            # Sleep before next check","            time.sleep(CHECK_INTERVAL)","            ","        except KeyboardInterrupt:","            logging.info(\"Shutting down JSON to SQLite converter...\")","            break","        except Exception as e:","            logging.error(f\"Error in monitor loop: {e}\")","            time.sleep(CHECK_INTERVAL)","","if __name__ == \"__main__\":","    monitor_and_insert()","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000004,1000012,1000013,1000014,1000015,1000016,1000017,1000004,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000004,1000027,1000028,1000029,1000030,1000031,1000032,1000004,1000033,1000034,1000035,1000036,1000004,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000040,1000057,1000058,1000004,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000066,1000068,1000069,1000070,1000066,1000071,1000072,1000073,1000066,1000074,1000075,1000066,1000076,1000077,1000066,1000078,1000079,1000080,1000066,1000081,1000082,1000083,1000084,1000085,1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000102,1000103,1000066,1000104,1000105,1000066,1000106,1000107,1000066,1000108,1000109,1000110,1000004,1000111,1000112,1000113,1000114,1000113,1000115,1000116,1000117,1000113,1000040,1000118,1000119,1000120,1000040,1000121,1000122,1000040,1000123,1000124,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000133,1000130,1000134,1000135,1000136,1000137,1000133,1000130,1000138,1000139,1000130,1000140,1000141,1000142,1000143,1000127,1000144,1000145,1000127,1000146,1000147,1000148,1000149,1000150,1000145,1000004,1000151,1000152,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}