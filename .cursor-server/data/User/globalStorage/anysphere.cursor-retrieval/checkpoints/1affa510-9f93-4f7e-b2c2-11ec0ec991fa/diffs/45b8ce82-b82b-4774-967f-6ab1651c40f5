{"fsPath":"\\home\\jarvis\\NetGuard\\scripts\\pcap_to_json.py","fileUuid":"45b8ce82-b82b-4774-967f-6ab1651c40f5","fileSizeBytes":7403,"numLines":207,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":208,"addedLines":["#!/usr/bin/env python3","\"\"\"","NetGuard Pro - PCAP to JSON Converter","Monitors tcpdump capture directory and converts PCAP files to JSON format","\"\"\"","","import os","import json","import time","import subprocess","import logging","from datetime import datetime","from pathlib import Path","","# Configuration","CAPTURE_DIR = \"/home/jarvis/NetGuard/captures/tcpdump\"","JSON_DIR = \"/home/jarvis/NetGuard/captures/processed_json\"","LOG_FILE = \"/home/jarvis/NetGuard/logs/system/pcap-to-json.log\"","PROCESSED_FILES = \"/home/jarvis/NetGuard/logs/system/processed_pcaps.txt\"","CHECK_INTERVAL = 10  # seconds","","# Setup logging","logging.basicConfig(","    level=logging.INFO,","    format='%(asctime)s - %(levelname)s - %(message)s',","    handlers=[","        logging.FileHandler(LOG_FILE),","        logging.StreamHandler()","    ]",")","","def load_processed_files():","    \"\"\"Load list of already processed PCAP files\"\"\"","    if os.path.exists(PROCESSED_FILES):","        with open(PROCESSED_FILES, 'r') as f:","            return set(line.strip() for line in f)","    return set()","","def mark_as_processed(filename):","    \"\"\"Mark a file as processed\"\"\"","    with open(PROCESSED_FILES, 'a') as f:","        f.write(f\"{filename}\\n\")","","def convert_pcap_to_json(pcap_file):","    \"\"\"Convert PCAP file to JSON using tshark\"\"\"","    try:","        # Extract timestamp from filename (capture_YYYYMMDD_HHMMSS.pcap)","        basename = os.path.basename(pcap_file)","        timestamp_str = basename.replace('capture_', '').replace('.pcap', '')","        ","        # Output JSON file","        json_file = os.path.join(JSON_DIR, f\"network_{timestamp_str}.json\")","        ","        logging.info(f\"Converting {basename} to JSON...\")","        ","        # Use tshark to convert PCAP to JSON","        # -r: read from file","        # -T: output format (json)","        # -e: fields to extract","        cmd = [","            'tshark', '-r', pcap_file,","            '-T', 'json',","            '-e', 'frame.time',","            '-e', 'frame.number',","            '-e', 'frame.len',","            '-e', 'ip.src',","            '-e', 'ip.dst',","            '-e', 'tcp.srcport',","            '-e', 'tcp.dstport',","            '-e', 'udp.srcport',","            '-e', 'udp.dstport',","            '-e', 'ip.proto',","            '-e', 'frame.protocols',","            '-e', 'tcp.flags',","            '-e', 'ip.ttl'","        ]","        ","        result = subprocess.run(cmd, capture_output=True, text=True, timeout=300)","        ","        if result.returncode == 0 and result.stdout:","            # Parse and simplify JSON","            packets = json.loads(result.stdout)","            simplified_packets = []","            ","            for packet in packets:","                layers = packet.get('_source', {}).get('layers', {})","                ","                # Extract fields","                src_ip = layers.get('ip.src', [''])[0] if 'ip.src' in layers else ''","                dst_ip = layers.get('ip.dst', [''])[0] if 'ip.dst' in layers else ''","                ","                # Get port (try TCP first, then UDP)","                src_port = layers.get('tcp.srcport', layers.get('udp.srcport', ['']))[0]","                dst_port = layers.get('tcp.dstport', layers.get('udp.dstport', ['']))[0]","                ","                # Convert port to int if available","                try:","                    src_port = int(src_port) if src_port else None","                except:","                    src_port = None","                    ","                try:","                    dst_port = int(dst_port) if dst_port else None","                except:","                    dst_port = None","                ","                # Determine protocol","                protocols = layers.get('frame.protocols', [''])[0]","                if 'tcp' in protocols.lower():","                    protocol = 'TCP'","                elif 'udp' in protocols.lower():","                    protocol = 'UDP'","                elif 'icmp' in protocols.lower():","                    protocol = 'ICMP'","                else:","                    protocol = layers.get('ip.proto', [''])[0]","                ","                simplified = {","                    'timestamp': layers.get('frame.time', [''])[0],","                    'frame_number': layers.get('frame.number', [''])[0],","                    'source_ip': src_ip,","                    'source_port': src_port,","                    'destination_ip': dst_ip,","                    'destination_port': dst_port,","                    'protocol': protocol,","                    'packet_length': layers.get('frame.len', [''])[0],","                    'flags': layers.get('tcp.flags', [''])[0],","                    'ttl': layers.get('ip.ttl', [''])[0]","                }","                ","                simplified_packets.append(simplified)","            ","            # Write simplified JSON","            with open(json_file, 'w') as f:","                json.dump(simplified_packets, f, indent=2)","            ","            logging.info(f\"✓ Converted {basename} -> {os.path.basename(json_file)} ({len(simplified_packets)} packets)\")","            return json_file","        else:","            logging.error(f\"✗ tshark failed for {basename}: {result.stderr}\")","            return None","            ","    except subprocess.TimeoutExpired:","        logging.error(f\"✗ Timeout converting {pcap_file}\")","        return None","    except Exception as e:","        logging.error(f\"✗ Error converting {pcap_file}: {e}\")","        return None","","def monitor_and_convert():","    \"\"\"Monitor capture directory and convert new PCAP files\"\"\"","    logging.info(\"=\" * 60)","    logging.info(\"NetGuard Pro - PCAP to JSON Converter\")","    logging.info(\"=\" * 60)","    logging.info(f\"Monitoring directory: {CAPTURE_DIR}\")","    logging.info(f\"JSON output directory: {JSON_DIR}\")","    logging.info(f\"Check interval: {CHECK_INTERVAL} seconds\")","    logging.info(\"=\" * 60)","    ","    # Create directories if they don't exist","    os.makedirs(CAPTURE_DIR, exist_ok=True)","    os.makedirs(JSON_DIR, exist_ok=True)","    os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)","    ","    # Load processed files","    processed = load_processed_files()","    ","    while True:","        try:","            # Get all PCAP files","            pcap_files = sorted(Path(CAPTURE_DIR).glob('capture_*.pcap'))","            ","            for pcap_file in pcap_files:","                pcap_path = str(pcap_file)","                ","                # Skip if already processed","                if pcap_path in processed:","                    continue","                ","                # Check if file is still being written (older than 30 seconds)","                file_age = time.time() - os.path.getmtime(pcap_path)","                if file_age < 30:","                    logging.debug(f\"Skipping {pcap_file.name} (still being written)\")","                    continue","                ","                # Convert to JSON","                json_file = convert_pcap_to_json(pcap_path)","                ","                if json_file:","                    # Mark as processed","                    processed.add(pcap_path)","                    mark_as_processed(pcap_path)","            ","            # Sleep before next check","            time.sleep(CHECK_INTERVAL)","            ","        except KeyboardInterrupt:","            logging.info(\"Shutting down PCAP to JSON converter...\")","            break","        except Exception as e:","            logging.error(f\"Error in monitor loop: {e}\")","            time.sleep(CHECK_INTERVAL)","","if __name__ == \"__main__\":","    monitor_and_convert()","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000001,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000004,1000012,1000013,1000014,1000015,1000016,1000017,1000004,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000004,1000027,1000028,1000029,1000030,1000031,1000032,1000004,1000033,1000034,1000035,1000036,1000004,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000043,1000046,1000043,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000043,1000068,1000043,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000076,1000080,1000081,1000082,1000076,1000083,1000084,1000085,1000086,1000087,1000088,1000084,1000089,1000086,1000090,1000076,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000076,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000108,1000109,1000110,1000111,1000112,1000076,1000113,1000073,1000114,1000115,1000116,1000073,1000117,1000118,1000119,1000120,1000121,1000073,1000122,1000123,1000124,1000125,1000126,1000124,1000004,1000127,1000128,1000129,1000130,1000129,1000131,1000132,1000133,1000129,1000134,1000135,1000136,1000137,1000138,1000134,1000139,1000140,1000134,1000141,1000142,1000143,1000144,1000073,1000145,1000146,1000076,1000147,1000148,1000149,1000076,1000150,1000151,1000152,1000153,1000149,1000076,1000154,1000155,1000076,1000156,1000157,1000158,1000159,1000073,1000160,1000161,1000073,1000162,1000163,1000164,1000165,1000166,1000161,1000004,1000167,1000168,1000004,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}